"use strict";(self.webpackChunkotter_shell=self.webpackChunkotter_shell||[]).push([[211],{3905:(e,a,n)=>{n.d(a,{Zo:()=>d,kt:()=>m});var r=n(7294);function o(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function t(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);a&&(r=r.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?t(Object(n),!0).forEach((function(a){o(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function l(e,a){if(null==e)return{};var n,r,o=function(e,a){if(null==e)return{};var n,r,o={},t=Object.keys(e);for(r=0;r<t.length;r++)n=t[r],a.indexOf(n)>=0||(o[n]=e[n]);return o}(e,a);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(r=0;r<t.length;r++)n=t[r],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var i=r.createContext({}),c=function(e){var a=r.useContext(i),n=a;return e&&(n="function"==typeof e?e(a):s(s({},a),e)),n},d=function(e){var a=c(e.components);return r.createElement(i.Provider,{value:a},e.children)},u={inlineCode:"code",wrapper:function(e){var a=e.children;return r.createElement(r.Fragment,{},a)}},p=r.forwardRef((function(e,a){var n=e.components,o=e.mdxType,t=e.originalType,i=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),p=c(n),m=o,f=p["".concat(i,".").concat(m)]||p[m]||u[m]||t;return n?r.createElement(f,s(s({ref:a},d),{},{components:n})):r.createElement(f,s({ref:a},d))}));function m(e,a){var n=arguments,o=a&&a.mdxType;if("string"==typeof e||o){var t=n.length,s=new Array(t);s[0]=p;var l={};for(var i in a)hasOwnProperty.call(a,i)&&(l[i]=a[i]);l.originalType=e,l.mdxType="string"==typeof e?e:o,s[1]=l;for(var c=2;c<t;c++)s[c]=n[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},2763:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>i,contentTitle:()=>s,default:()=>u,frontMatter:()=>t,metadata:()=>l,toc:()=>c});var r=n(7462),o=(n(7294),n(3905));const t={sidebar_position:27},s="Instalaci\xf3n y configuraci\xf3n de un servidor DNS esclavo",l={unversionedId:"Tasks/DNS_esclavo",id:"Tasks/DNS_esclavo",title:"Instalaci\xf3n y configuraci\xf3n de un servidor DNS esclavo",description:"Procedimiento",source:"@site/docs/Tasks/DNS_esclavo.md",sourceDirName:"Tasks",slug:"/Tasks/DNS_esclavo",permalink:"/docs/Tasks/DNS_esclavo",draft:!1,editUrl:"https://github.com/belennazareth/ottershell/blob/main/docs/Tasks/DNS_esclavo.md",tags:[],version:"current",sidebarPosition:27,frontMatter:{sidebar_position:27},sidebar:"tutorialSidebar",previous:{title:"Gesti\xf3n de pool de almacenamiento l\xf3gico en KVM/libvirt",permalink:"/docs/Tasks/almacenamiento_kvm_libvirt"},next:{title:"Protocolo DHCP",permalink:"/docs/Tasks/dhcp"}},i={},c=[{value:"Procedimiento",id:"procedimiento",level:2},{value:"Entrega",id:"entrega",level:2}],d={toc:c};function u(e){let{components:a,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},d,n,{components:a,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"instalaci\xf3n-y-configuraci\xf3n-de-un-servidor-dns-esclavo"},"Instalaci\xf3n y configuraci\xf3n de un servidor DNS esclavo"),(0,o.kt)("h2",{id:"procedimiento"},"Procedimiento"),(0,o.kt)("p",null,"Un servidor DNS esclavo contiene una r\xe9plica de las zonas del servidor maestro. Se debe producir una transferencia de zona (el esclavo hace una solicitud de la zona completa al maestro) para que se sincronicen los servidores."),(0,o.kt)("hr",null),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"    IPs\n")),(0,o.kt)("p",null,"Servidor: 172.22.5.136\nCliente: 172.22.1.35\nEsclavo: 172.22.4.145"),(0,o.kt)("hr",null),(0,o.kt)("p",null,"1.- Crea otra m\xe1quina en Proxmox que tendr\xe1 el rol de servidor DNS esclavo. Instala bind9 y nombralo de manera adecuada para que tenga el nombre dns2.tunombre.org. Voy a suponer que la direcci\xf3n de esta nueva m\xe1quina es la 172.22.200.110. La transferencia de zona entre maestro y esclavo usa el puerto 53/tcp, \xe1brelo en el grupo de seguridad."),(0,o.kt)("p",null,"Para esto ejecutamos el siguiente comando:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo hostnamectl set-hostname dns2\n")),(0,o.kt)("p",null,"Y editamos el fichero /etc/hosts para que tenga el nombre dns2.tunombre.org:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"127.0.1.1 dns2.nazareth.org dns2\n")),(0,o.kt)("p",null,"2.- Por seguridad, s\xf3lo debemos aceptar transferencias de zonas hac\xeda los esclavos autorizados, para ello en el fichero /etc/bind/named.conf.options, deshabilitamos las transferencias:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"}," options {\n     ...\n     allow-transfer { none; };\n     ...\n")),(0,o.kt)("p",null,"3.- Modificamos la definici\xf3n de las zona en el servidor DNS maestro. Modificamos el fichero /etc/bind/named.conf.local:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'include "/etc/bind/zones.rfc1918";\nzone "nazareth.org" {\n    type master;\n    file "db.nazareth.org";\n    allow-transfer { 172.22.4.145; };\n    notify yes;\n};\nzone "22.172.in-addr.arpa" {\n    type master;\n    file "db.172.22.0.0";\n    allow-transfer { 172.22.4.145; };\n    notify yes;\n};\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"allow-tranfer: Se permite las transferencias de zonas al servidor DNS esclavo (172.22.200.110).")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"notify yes: Cuando se reinicie el servidor DNS maestro se notificar\xe1 al esclavo que ha habido cambios para que solicite una transferencia de zona."))),(0,o.kt)("p",null,"4.- Modificamos la definici\xf3n de las zona en el servidor DNS esclavo. Modificamos el fichero /etc/bind/named.conf.local:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},' include "/etc/bind/zones.rfc1918";\n zone "nazareth.org" {\n     type slave;\n     file "db.nazareth.org";\n     masters { 172.22.4.145; };\n };\n zone "22.172.in-addr.arpa" {\n     type slave;\n     file "db.172.22.0.0";\n     masters { 172.22.4.145; };\n }; \n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"type slave: Se indica que este servidor ser\xe1 esclavo para estas zonas."),(0,o.kt)("li",{parentName:"ul"},"masters: Se indica cu\xe1l es el maestro, para saber a que servidor hay que solicitar la transferencia de zona.")),(0,o.kt)("p",null,"5.- En el servidor DNS maestro a\xf1adimos la informaci\xf3n del servidor DNS esclavo en las zonas. En la zona de resoluci\xf3n directa, en el fichero /var/cache/bind/db.tunombre.org a\xf1adimos un nuevo registro NS y su correspondiente registro A:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$TTL    86400\n@       IN      SOA     dns1.nazareth.org. root.nazareth.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n\n@   IN  NS      dns1.nazareth.org.\n@   IN  NS      dns2.nazareth.org.\n@   IN  MX  10  correo.nazareth.org.\n\n$ORIGIN nazareth.org.\n\ndns1        IN  A   172.22.5.136\ndns2        IN  A   172.22.4.145\n...\n")),(0,o.kt)("p",null,"La zona de resoluci\xf3n inverso quedar\xeda de la siguiente forma, modificando el fichero /var/cache/bind/db.172.22.0.0:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$TTL    86400\n@       IN      SOA     dns1.nazareth.org. root.nazareth.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n\n@   IN  NS      dns1.nazareth.org.\n@   IN  NS      dns2.nazareth.org.\n\n$ORIGIN 22.172.in-addr.arpa.\n\n136.5       IN  PTR     dns1.nazareth.org.\n145.4       IN  PTR     dns2.nazareth.org.\n...\n")),(0,o.kt)("p",null,"*Nota: La informaci\xf3n de los registros de las zonas s\xf3lo se modifican en el servidor DNS maestro. Est\xe1s modificaciones se copia en el esclavo por medio de una transferencia de zona."),(0,o.kt)("p",null,"6.- Reinicia el servidor DNS maestro y esclavo. Puedes ver en el esclavo que se han producidos las transferencias de zonas:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"}," root@dns2:~# systemctl restart bind9\n root@dns2:~# tail /var/log/syslog\n ... dns2 named[5739]: zone 22.172.in-addr.arpa/IN: transferred serial 1\n ... dns2 named[5739]: transfer of '22.172.in-addr.arpa/IN' from 172.22.200.100#53: Transfer status: success\n ... dns2 named[5739]: transfer of '22.172.in-addr.arpa/IN' from 172.22.200.100#53: Transfer completed: ...\n ... dns2 named[5739]: managed-keys-zone: Key 20326 for zone . acceptance timer complete: key now trusted\n ... dns2 named[5739]: resolver priming query complete\n ... dns2 named[5739]: zone tunombre.org/IN: Transfer started.\n ... dns2 named[5739]: transfer of 'tunombre.org/IN' from 172.22.200.100#53: connected using 172.22.200.110#58461\n ... dns2 named[5739]: zone tunombre.org/IN: transferred serial 1\n ... dns2 named[5739]: transfer of 'tunombre.org/IN' from 172.22.200.100#53: Transfer status: success\n ... dns2 named[5739]: transfer of 'tunombre.org/IN' from 172.22.200.100#53: Transfer completed: ...\n")),(0,o.kt)("p",null,"7.- Si al reiniciar los servidores DNS tienes alg\xfan error, puedes detectar errores de sintaxis usando los siguientes comandos:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"}," named-checkzone tunombre.org /var/cache/bind/db.tunombre.org\n named-checkzone 22.172.in-addr.arpa /var/cache/bind/db.172.22.0.0  Para detectar errores de configuraci\xf3n en `named.conf`, podemos usar:\n named-checkconf\n")),(0,o.kt)("p",null,"8.- Configura el cliente con los dos servidores DNS. Para ello en su fichero /etc/resolv.conf utiliza dos directivas nameserver. Si hacemos una consulta desde un cliente, y el dns maestro no responde, responder\xe1 el esclavo. Prueba a realizar una consulta. \xbfQui\xe9n ha respondido?. Apaga el servidor maestro, y vuelve a hacer la misma consulta. \xbfHa respondido el servidor DNS esclavo?"),(0,o.kt)("p",null,"9.- Vamos a modificar la informaci\xf3n de la zona. Para ello vamos a modificar en el servidor DNS maestro y en su fichero /var/cache/bind/db.tunombre.org vamos a a\xf1adir un nuevo registro:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"}," ...\n prueba     IN  A   172.22.200.120\n\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Recuerda incrementar el n\xfamero de serie, para que al reiniciar el servidor DNS maestro se produzca la transferencia de zona.")),(0,o.kt)("p",null,"10.- Desde el cliente realiza una consulta para preguntar por la direcci\xf3n IP de prueba.tunombre.org. \xbfQui\xe9n ha respondido?. Apaga el servidor maestro, y vuelve a hacer la misma consulta. \xbfHa respondido el servidor DNS esclavo?. Comprueba en el esclavo que se ha producido la transferencia."),(0,o.kt)("p",null,"11.- Algunos trucos adicionales:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Puedes manejar el servidor DNS con el comando rndc. Por ejemplo rndc reload: reinicia el servicio; rndc reload tunombre.org: Reinicia s\xf3lo esa zona; rndc flush: Borra la cach\xe9 de resoluciones guardadas en el servidor.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Realiza una consulta al servidor maestro y el esclavo para comprobar que las respuestas son autorizadas (bit AA), adem\xe1s aseg\xfarate que coinciden los n\xfameros de serie:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"dig +norec @x.x.x.x tunombre.org. soa\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Solicita una copia completa de la zona y comprueba que s\xf3lo se puede hacer desde el esclavo:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"dig @x.x.x.x tunombre.org. axfr\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Cada vez que realice una modificaci\xf3n en el servidor DNS maestro recuerda incrementar el n\xfamero de serie.")))),(0,o.kt)("h2",{id:"entrega"},"Entrega"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1. Realizaci\xf3n del apartado 8.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2. Transferencia de zonas: indica para que sirve el n\xfamero de serie. Explica con tus palabras qu\xe9 indican los tiempos que se configuran en el registro SOA.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3. Realizaci\xf3n del apartado 10.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4. Realiza el ejercicio que te va a proponer el profesor.")))}u.isMDXComponent=!0}}]);