"use strict";(self.webpackChunkotter_shell=self.webpackChunkotter_shell||[]).push([[1408],{3905:(e,a,n)=>{n.d(a,{Zo:()=>d,kt:()=>k});var t=n(67294);function r(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function l(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function o(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?l(Object(n),!0).forEach((function(a){r(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function i(e,a){if(null==e)return{};var n,t,r=function(e,a){if(null==e)return{};var n,t,r={},l=Object.keys(e);for(t=0;t<l.length;t++)n=l[t],a.indexOf(n)>=0||(r[n]=e[n]);return r}(e,a);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(t=0;t<l.length;t++)n=l[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=t.createContext({}),c=function(e){var a=t.useContext(s),n=a;return e&&(n="function"==typeof e?e(a):o(o({},a),e)),n},d=function(e){var a=c(e.components);return t.createElement(s.Provider,{value:a},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},u=t.forwardRef((function(e,a){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),p=c(n),u=r,k=p["".concat(s,".").concat(u)]||p[u]||m[u]||l;return n?t.createElement(k,o(o({ref:a},d),{},{components:n})):t.createElement(k,o({ref:a},d))}));function k(e,a){var n=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=u;var i={};for(var s in a)hasOwnProperty.call(a,s)&&(i[s]=a[s]);i.originalType=e,i[p]="string"==typeof e?e:r,o[1]=i;for(var c=2;c<l;c++)o[c]=n[c];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}u.displayName="MDXCreateElement"},91569:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>l,metadata:()=>i,toc:()=>c});var t=n(87462),r=(n(67294),n(3905));const l={sidebar_position:50},o="Docker: Implantaci\xf3n de aplicaciones web PHP en docker",i={unversionedId:"Tasks/docker_PHP",id:"Tasks/docker_PHP",title:"Docker: Implantaci\xf3n de aplicaciones web PHP en docker",description:"Imaginemos que el equipo de desarrollo de nuestra empresa ha desarrollado una aplicaci\xf3n PHP que se llama BookMedik (https://github.com/evilnapsis/bookmedik).",source:"@site/docs/Tasks/docker_PHP.md",sourceDirName:"Tasks",slug:"/Tasks/docker_PHP",permalink:"/docs/Tasks/docker_PHP",draft:!1,editUrl:"https://github.com/belennazareth/ottershell/blob/main/docs/Tasks/docker_PHP.md",tags:[],version:"current",sidebarPosition:50,frontMatter:{sidebar_position:50},sidebar:"tutorialSidebar",previous:{title:"Docker: Escenarios multicontenedor en Docker",permalink:"/docs/Tasks/docker_multicontenedor"},next:{title:"Markdown Features",permalink:"/docs/Tasks/markdown-features"}},s={},c=[{value:"Tarea 1: Creaci\xf3n de una imagen docker con una aplicaci\xf3n web desde una imagen base",id:"tarea-1-creaci\xf3n-de-una-imagen-docker-con-una-aplicaci\xf3n-web-desde-una-imagen-base",level:2},{value:"Entrega",id:"entrega",level:3},{value:"Tarea 2: Despliegue en el entorno de desarrollo",id:"tarea-2-despliegue-en-el-entorno-de-desarrollo",level:2},{value:"Entrega",id:"entrega-1",level:3},{value:"Tarea 3: Creaci\xf3n de una imagen docker con una aplicaci\xf3n web desde una imagen PHP",id:"tarea-3-creaci\xf3n-de-una-imagen-docker-con-una-aplicaci\xf3n-web-desde-una-imagen-php",level:2},{value:"Entrega",id:"entrega-2",level:3},{value:"Tarea 4: Ejecuci\xf3n de una aplicaci\xf3n PHP en docker con nginx (OPTATIVA)",id:"tarea-4-ejecuci\xf3n-de-una-aplicaci\xf3n-php-en-docker-con-nginx-optativa",level:2},{value:"Entrega",id:"entrega-3",level:3},{value:"Tarea 5: Puesta en producci\xf3n de nuestra aplicaci\xf3n",id:"tarea-5-puesta-en-producci\xf3n-de-nuestra-aplicaci\xf3n",level:2},{value:"Entrega",id:"entrega-4",level:3},{value:"Tarea 6: Modificaci\xf3n de la aplicaci\xf3n",id:"tarea-6-modificaci\xf3n-de-la-aplicaci\xf3n",level:2},{value:"Entrega",id:"entrega-5",level:3}],d={toc:c},p="wrapper";function m(e){let{components:a,...l}=e;return(0,r.kt)(p,(0,t.Z)({},d,l,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"docker-implantaci\xf3n-de-aplicaciones-web-php-en-docker"},"Docker: Implantaci\xf3n de aplicaciones web PHP en docker"),(0,r.kt)("p",null,"Imaginemos que el equipo de desarrollo de nuestra empresa ha desarrollado una aplicaci\xf3n PHP que se llama BookMedik (",(0,r.kt)("a",{parentName:"p",href:"https://github.com/evilnapsis/bookmedik"},"https://github.com/evilnapsis/bookmedik"),")."),(0,r.kt)("p",null,"Queremos crear una imagen Docker para implantar dicha aplicaci\xf3n."),(0,r.kt)("p",null,"Tenemos que tener en cuenta los siguientes aspectos:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Contenedor mariadb")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Es necesario que nuestra aplicaci\xf3n guarde su informaci\xf3n en un contenedor docker mariadb."),(0,r.kt)("li",{parentName:"ul"},"El script para generar la base de datos y los registros lo encuentras en el repositorio y se llama ",(0,r.kt)("inlineCode",{parentName:"li"},"schema.sql"),". Debes crear un usuario con su contrase\xf1a en la base de datos. La base de datos se llama bookmedik y se crea al ejecutar el script."),(0,r.kt)("li",{parentName:"ul"},"Ejecuta el contenedor mariadb y carga los datos del script ",(0,r.kt)("inlineCode",{parentName:"li"},"schema.sql"),". Para m\xe1s ",(0,r.kt)("a",{parentName:"li",href:"https://gist.github.com/spalladino/6d981f7b33f6e0afe6bb"},"informaci\xf3n"),"."),(0,r.kt)("li",{parentName:"ul"},"El contenedor mariadb debe tener un volumen para guardar la base de datos.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Contenedor bookmedik")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Vamos a crear tres versiones de la imagen que nos permite implantar la aplicaci\xf3n PHP."),(0,r.kt)("li",{parentName:"ul"},"La imagen debe crear las variables de entorno necesarias con datos de conexi\xf3n por defecto."),(0,r.kt)("li",{parentName:"ul"},"Al crear un contenedor a partir de estas im\xe1genes se ejecutar\xe1 un script bash que realizar\xe1 las siguientes tareas:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Modifique el fichero core\\controller\\Database.php para que lea las variables de entorno. Para obtener las variables de entorno en PHP usar la funci\xf3n getenv. ",(0,r.kt)("a",{parentName:"li",href:"https://www.php.net/manual/es/function.getenv.php"},"Para m\xe1s informaci\xf3n"),"."),(0,r.kt)("li",{parentName:"ul"},"Inicialice la base de datos con el fichero ",(0,r.kt)("inlineCode",{parentName:"li"},"schema.sql"),"."),(0,r.kt)("li",{parentName:"ul"},"Ejecute el servidor web."))),(0,r.kt)("li",{parentName:"ul"},"El contenedor que creas debe tener un volumen para guardar los logs del servidor web."),(0,r.kt)("li",{parentName:"ul"},"La imagen la tienes que crear en tu entorno de desarrollo con el comando ",(0,r.kt)("inlineCode",{parentName:"li"},"docker build"),".")),(0,r.kt)("h2",{id:"tarea-1-creaci\xf3n-de-una-imagen-docker-con-una-aplicaci\xf3n-web-desde-una-imagen-base"},"Tarea 1: Creaci\xf3n de una imagen docker con una aplicaci\xf3n web desde una imagen base"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Vamos a crear una imagen que se llame ",(0,r.kt)("inlineCode",{parentName:"li"},"usuario/bookmedik:v1"),"."),(0,r.kt)("li",{parentName:"ul"},"Crea una imagen docker con la aplicaci\xf3n desde una imagen base de debian o ubuntu.")),(0,r.kt)("p",null,"Primero clonamos el repositorio de la aplicaci\xf3n bookmedik:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/evilnapsis/bookmedik.git\n")),(0,r.kt)("p",null,"Modificamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"schema.sql")," y quitamos las primeras l\xedneas que son las que crean y usan la base de datos ",(0,r.kt)("inlineCode",{parentName:"p"},"bookmedik")," para que no nos de error al crear la base de datos en el contenedor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE DATABASE bookmedik;\nUSE bookmedik;\n")),(0,r.kt)("p",null,"Modificamos las variables de entorno en el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"core\\controller\\Database.php")," para que lea las que vamos a darle en el script de mysql:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"        function Database(){\n                $this->user=getenv('bookmedik_user');$this->pass=getenv('bookmedik_passwd');$this->host=getenv('host_database');$this->ddbb=getenv('db_name');\n        }\n")),(0,r.kt)("p",null,"Creamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," con las instrucciones para crear la imagen:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM debian:bullseye\nMAINTAINER Belen Nazareth Duran "belennazareth29@gmail.com"\nRUN apt-get update && apt-get upgrade -y && apt-get install apache2 libapache2-mod-php php php-mysql mariadb-client -y && apt-get clean && rm -rf /var/lib/apt/lists/*\nCOPY bookmedik /var/www/html/\nADD script.sh /opt/\nRUN chmod +x /opt/script.sh && rm /var/www/html/index.html\nCMD ["/opt/script.sh"]\n')),(0,r.kt)("p",null,"Creamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"script.sh")," con las instrucciones para ejecutar el contenedor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-s"},'#! /bin/sh\n\nwhile ! mysqladmin ping -h"$host_database" --silent; do\n    echo "Esperando a que el servicio de mysql este disponible..."\n    sleep 1\ndone\n\nmysql -u $bookmedik_user --password=$bookmedik_passwd -h $host_database $db_name < /var/www/html/schema.sql\n\n/usr/sbin/apache2ctl -D FOREGROUND\n')),(0,r.kt)("p",null,"Creamos la imagen:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t belennazareth/bookmedik:v1 .\n")),(0,r.kt)("p",null,"Comprobamos que se ha creado correctamente:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker images\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(69578).Z,width:"816",height:"293"})),(0,r.kt)("h3",{id:"entrega"},"Entrega"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Entrega la url del repositorio GitHub donde tengas los ficheros necesarios para hacer la construcci\xf3n de la imagen.")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/belennazareth/Docker_PHP/tree/main/tarea1"},"https://github.com/belennazareth/Docker_PHP/tree/main/tarea1")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Entrega una captura de pantalla donde se vea la imagen en el registro de tu entorno de desarrollo.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(69578).Z,width:"816",height:"293"})),(0,r.kt)("h2",{id:"tarea-2-despliegue-en-el-entorno-de-desarrollo"},"Tarea 2: Despliegue en el entorno de desarrollo"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Crea un script con ",(0,r.kt)("inlineCode",{parentName:"li"},"docker-compose")," que levante el escenario con los dos contenedores."),(0,r.kt)("li",{parentName:"ul"},"Recuerda que para acceder a la aplicaci\xf3n: Usuario: ",(0,r.kt)("strong",{parentName:"li"},"admin"),", contrase\xf1a: ",(0,r.kt)("strong",{parentName:"li"},"admin"),".")),(0,r.kt)("p",null,"Creamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," con las instrucciones para levantar el escenario:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"version: '3.7'\nservices:\n  bn-mariadb:\n    container_name: bn-mariadb\n    image: mariadb\n    restart: always\n    environment:\n      MARIADB_ROOT_PASSWORD: root\n      MARIADB_DATABASE: bookmedik\n      MARIADB_USER: admin\n      MARIADB_PASSWORD: admin\n    volumes:\n      - mariadb_data:/var/lib/mysql\n  bookmedik:\n    container_name: bn-bookmedik\n    image: belennazareth/bookmedik:v1\n    restart: always\n    environment:\n      bookmedik_user: admin\n      bookmedik_passwd: admin\n      host_database: bn-mariadb\n      db_name: bookmedik\n    ports:\n      - 8081:80\n    depends_on:\n      - bn-mariadb\nvolumes:\n    mariadb_data:\n")),(0,r.kt)("p",null,"Levantamos el escenario:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d \n")),(0,r.kt)("p",null,"Comprobamos que se ha levantado correctamente:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker ps\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(56563).Z,width:"1489",height:"376"})),(0,r.kt)("p",null,"Si accedemos a la aplicaci\xf3n en el puerto 8081, ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost:8081"),", podemos ver que se ha creado correctamente:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(56964).Z,width:"992",height:"734"}),"\n",(0,r.kt)("img",{alt:"DOCKER",src:n(60942).Z,width:"992",height:"734"})),(0,r.kt)("h3",{id:"entrega-1"},"Entrega"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Entrega la url del repositorio GitHub donde hayas a\xf1adido el fichero docker-compose.yml.")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/belennazareth/Docker_PHP/tree/main/tarea2"},"https://github.com/belennazareth/Docker_PHP/tree/main/tarea2")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Entrega la instrucci\xf3n para ver los dos contenedores del escenario funcionando.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(56563).Z,width:"1489",height:"376"})),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Entrega una captura de pantalla donde se vea funcionando la aplicaci\xf3n, una vez que te has logueado.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(56964).Z,width:"992",height:"734"}),"\n",(0,r.kt)("img",{alt:"DOCKER",src:n(60942).Z,width:"992",height:"734"})),(0,r.kt)("h2",{id:"tarea-3-creaci\xf3n-de-una-imagen-docker-con-una-aplicaci\xf3n-web-desde-una-imagen-php"},"Tarea 3: Creaci\xf3n de una imagen docker con una aplicaci\xf3n web desde una imagen PHP"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Vamos a crear una imagen que se llame ",(0,r.kt)("inlineCode",{parentName:"li"},"usuario/bookmedik:v2"),"."),(0,r.kt)("li",{parentName:"ul"},"Realiza la imagen docker de la aplicaci\xf3n a partir de la imagen oficial ",(0,r.kt)("a",{parentName:"li",href:"https://hub.docker.com/_/php/"},"PHP")," que encuentras en docker hub. Lee la documentaci\xf3n de la imagen para configurar una imagen con apache2 y php, adem\xe1s seguramente tengas que instalar alguna extensi\xf3n de php."),(0,r.kt)("li",{parentName:"ul"},"Modifica el fichero ",(0,r.kt)("inlineCode",{parentName:"li"},"docker-compose.yml")," para probar esta imagen.")),(0,r.kt)("p",null,"Creamos el ",(0,r.kt)("inlineCode",{parentName:"p"},"dockerfile"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM php:7.4-apache-bullseye\nMAINTAINER Belen Nazareth Duran "belennazareth29@gmail.com"\nRUN apt update && apt upgrade -y && docker-php-ext-install mysqli pdo pdo_mysql && apt install mariadb-client -y && apt clean && rm -rf /var/lib/apt/lists/*\nCOPY bookmedik /var/www/html/\nADD script.sh /opt/\nRUN chmod +x /opt/script.sh \nCMD ["/opt/script.sh"]\n')),(0,r.kt)("p",null,"Modificamos el script ",(0,r.kt)("inlineCode",{parentName:"p"},"script.sh"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-s"},'#! /bin/sh\nwhile ! mysql -u ${bookmedik_user} -p${bookmedik_passwd} -h ${host_database} -e ";" ; do\n    echo "Esperando a que el servicio de mysql este disponible..."\n    sleep 1\ndone\n\nmysql -u $bookmedik_user --password=$bookmedik_passwd -h $host_database $db_name < /var/www/html/schema.sql\n/usr/sbin/apache2ctl -D FOREGROUND\n')),(0,r.kt)("p",null,"Creamos la imagen:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t belennazareth/bookmedik:v2 .\n")),(0,r.kt)("p",null,"Modificamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"version: '3.7'\nservices:\n  bn-mariadb:\n    container_name: bn-mariadb\n    image: mariadb\n    restart: always\n    environment:\n      MARIADB_ROOT_PASSWORD: root\n      MARIADB_DATABASE: bookmedik\n      MARIADB_USER: admin\n      MARIADB_PASSWORD: admin\n    volumes:\n      - mariadb_data:/var/lib/mysql\n  bookmedik:\n    container_name: bn-bookmedik\n    image: belennazareth/bookmedik:v2\n    restart: always\n    environment:\n      bookmedik_user: admin\n      bookmedik_passwd: admin\n      host_database: bn-mariadb\n      db_name: bookmedik\n    ports:\n      - 8081:80\n    depends_on:\n      - bn-mariadb\nvolumes:\n    mariadb_data:\n")),(0,r.kt)("p",null,"Levantamos el escenario:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d \n")),(0,r.kt)("h3",{id:"entrega-2"},"Entrega"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Entrega la url del repositorio GitHub donde tengas los ficheros necesarios para hacer la construcci\xf3n de la imagen.")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/belennazareth/Docker_PHP/tree/main/tarea3"},"https://github.com/belennazareth/Docker_PHP/tree/main/tarea3")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Entrega una captura de pantalla donde se vea la imagen en el registro de tu entorno de desarrollo."),(0,r.kt)("p",{parentName:"li"},"docker images"))),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(93752).Z,width:"940",height:"353"})),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Entrega la instrucci\xf3n para ver los dos contenedores del escenario funcionando."),(0,r.kt)("p",{parentName:"li"},"docker ps"))),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(31810).Z,width:"1367",height:"122"})),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Entrega una captura de pantalla donde se vea funcionando la aplicaci\xf3n, una vez que te has logueado.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(50702).Z,width:"1101",height:"699"}),"\n",(0,r.kt)("img",{alt:"DOCKER",src:n(76457).Z,width:"1101",height:"924"})),(0,r.kt)("h2",{id:"tarea-4-ejecuci\xf3n-de-una-aplicaci\xf3n-php-en-docker-con-nginx-optativa"},"Tarea 4: Ejecuci\xf3n de una aplicaci\xf3n PHP en docker con nginx (OPTATIVA)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Vamos a crear una imagen que se llame usuario/bookmedik:v3."),(0,r.kt)("li",{parentName:"ul"},"En este caso queremos usar un contenedor que utilice nginx para servir la aplicaci\xf3n PHP. Puedes crear la imagen desde una imagen base debian o ubuntu o desde la imagen oficial de nginx."),(0,r.kt)("li",{parentName:"ul"},"Vamos a crear otro contenedor que sirva php-fpm."),(0,r.kt)("li",{parentName:"ul"},"Para que funcione de forma adecuada el php-fpm tiene que tener acceso al directorio donde se encuentra la aplicaci\xf3n."),(0,r.kt)("li",{parentName:"ul"},"Y finalmente nuestro contenedor con la aplicaci\xf3n."),(0,r.kt)("li",{parentName:"ul"},"Crea un script con docker compose que levante el escenario con los tres contenedores.")),(0,r.kt)("p",null,"A lo mejor te puede ayudar el siguiente enlace: ",(0,r.kt)("a",{parentName:"p",href:"http://geekyplatypus.com/dockerise-your-php-application-with-nginx-and-php7-fpm/"},"Dockerise your PHP application with Nginx and PHP7-FPM")),(0,r.kt)("p",null,"Hay que hacer dos imagenes, una con nginx y otra con php-fpm."),(0,r.kt)("p",null,"Primero creamos el ",(0,r.kt)("inlineCode",{parentName:"p"},"dockerfile")," de php-fpm:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM php:7.4-fpm\nMAINTAINER Belen Nazareth Duran "belennazareth29@gmail.com"\nRUN docker-php-ext-install mysqli\n')),(0,r.kt)("p",null,"Construimos la imagen:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t belennazareth/php-fpm-mysql:v1 .\n")),(0,r.kt)("p",null,"Creamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"default.conf")," como configuraci\xf3n de nginx:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n    listen       80;\n    listen  [::]:80;\n    server_name  localhost;\n    error_log  /var/log/nginx/error.log;\n    access_log /var/log/nginx/access.log;\n    root   /usr/share/nginx/html;\n    index  index.php index.html;\n\n    location ~ \\.php$ {\n        try_files $uri =404;\n        fastcgi_split_path_info ^(.+\\.php)(/.+)$;\n        fastcgi_pass book_php:9000;\n        fastcgi_index index.php;\n        include fastcgi_params;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        fastcgi_param PATH_INFO $fastcgi_path_info;\n    }\n}\n")),(0,r.kt)("p",null,"Modificamos el ",(0,r.kt)("inlineCode",{parentName:"p"},"script.sh"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-s"},'#! /bin/sh\n\nsleep 10\n\nmysql -u $bookmedik_user --password=$bookmedik_passwd -h $host_database $db_name  < /usr/share/nginx/html/schema.sql\n\nnginx -g "daemon off;"\n')),(0,r.kt)("p",null,"Para la imagen de nginx, creamos el ",(0,r.kt)("inlineCode",{parentName:"p"},"dockerfile"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM nginx\nMAINTAINER Belen Nazareth Duran "belennazareth29@gmail.com"\nRUN apt-get update && apt-get upgrade -y && apt-get install mariadb-client -y && apt-get clean && rm -rf /var/lib/apt/lists/*\nADD default.conf /etc/nginx/conf.d/\nADD bookmedik /usr/share/nginx/html\nADD script.sh /opt/\nRUN chmod +x /opt/script.sh && rm /usr/share/nginx/html/index.html\nENTRYPOINT ["/opt/script.sh"]\n')),(0,r.kt)("p",null,"Construimos la imagen:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t belennazareth/bookmedik:v3 .\n")),(0,r.kt)("p",null,"Creamos el ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"version: '3.8'\nservices:\n  bookmedik:\n    container_name: bookmedik-app\n    image: legnakra/bookmedik:v3\n    restart: always\n    environment:\n      USUARIO_BOOKMEDIK: bookmedik\n      CONTRA_BOOKMEDIK: bookmedik\n      DATABASE_HOST: bd_mariadb\n      NOMBRE_DB: bookmedik\n    ports:\n      - 8082:80\n    depends_on:\n      - db\n      - php\n    volumes:\n      - phpdocs:/usr/share/nginx/html/\n  db:\n    container_name: bd_mariadb\n    image: mariadb\n    restart: always\n    environment:\n      MARIADB_ROOT_PASSWORD: root\n      MARIADB_DATABASE: bookmedik\n      MARIADB_USER: bookmedik\n      MARIADB_PASSWORD: bookmedik\n    volumes:\n      - mariadb_data:/var/lib/mysql\n  php:\n    container_name: book_php\n    image: legnakra/php-fpm-mysql:v1\n    restart: always\n    environment:\n      USUARIO_BOOKMEDIK: bookmedik\n      CONTRA_BOOKMEDIK: bookmedik\n      DATABASE_HOST: bd_mariadb\n      NOMBRE_DB: bookmedik\n    volumes:\n      - phpdocs:/usr/share/nginx/html/ \n\nvolumes:\n    mariadb_data:\n    phpdocs:\n")),(0,r.kt)("h3",{id:"entrega-3"},"Entrega"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Entrega la url del repositorio GitHub donde tengas los ficheros necesarios para hacer la construcci\xf3n de la imagen.")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/belennazareth/Docker_PHP/tree/main/tarea4"},"https://github.com/belennazareth/Docker_PHP/tree/main/tarea4")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Entrega una captura de pantalla donde se vea la imagen en el registro de tu entorno de desarrollo.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Entrega la instrucci\xf3n para ver los tres contenedores del escenario funcionando.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Entrega una captura de pantalla donde se vea funcionando la aplicaci\xf3n, una vez que te has logueado."))),(0,r.kt)("h2",{id:"tarea-5-puesta-en-producci\xf3n-de-nuestra-aplicaci\xf3n"},"Tarea 5: Puesta en producci\xf3n de nuestra aplicaci\xf3n"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Elige una de las tres im\xe1genes y s\xfabela a Docker Hub."),(0,r.kt)("li",{parentName:"ul"},"En tu VPS instala Docker y utilizando el ",(0,r.kt)("inlineCode",{parentName:"li"},"docker-compose.yml")," correspondiente, crea un contenedor en ella de la aplicaci\xf3n."),(0,r.kt)("li",{parentName:"ul"},"Configura el nginx de tu VPS para que haga de proxy inverso y nos permita acceder a la aplicaci\xf3n con ",(0,r.kt)("inlineCode",{parentName:"li"},"https://bookmedik.tudominio.xxx"),".")),(0,r.kt)("p",null,"Uso la imagen de la tarea 3 y la subo a Docker Hub:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker push belennazareth/bookmedik:v2\n")),(0,r.kt)("p",null,"En la VPS instalamos Docker y creamos el ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt install docker.io\nsudo apt install docker-compose\n")),(0,r.kt)("p",null,"Hacemos un docker pull de la imagen:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker pull belennazareth/bookmedik:v2\n")),(0,r.kt)("p",null,"A continuaci\xf3n creamos el ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"version: '3.3'\nservices:\n  bn-mariadb:\n    container_name: bn-mariadb\n    image: mariadb\n    restart: always\n    environment:\n      MARIADB_ROOT_PASSWORD: root\n      MARIADB_DATABASE: bookmedik\n      MARIADB_USER: admin\n      MARIADB_PASSWORD: admin\n    volumes:\n      - mariadb_data:/var/lib/mysql\n  bookmedik:\n    container_name: bn-bookmedik\n    image: belennazareth/bookmedik:v2\n    restart: always\n    environment:\n      bookmedik_user: admin\n      bookmedik_passwd: admin\n      host_database: bn-mariadb\n      db_name: bookmedik\n    ports:\n      - 8081:80\n    depends_on:\n      - bn-mariadb\nvolumes:\n    mariadb_data:\n")),(0,r.kt)("p",null,"*Nota: en mi caso he tenido que poner la version 10.8.2 de mariadb, ya que con la \xfaltima versi\xf3n me daba error."),(0,r.kt)("p",null,"Levantamos los contenedores:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d\n")),(0,r.kt)("p",null,"Por \xfaltimo, configuramos el nginx para que haga de proxy inverso y nos permita acceder a la aplicaci\xf3n con ",(0,r.kt)("inlineCode",{parentName:"p"},"https://bookmedik.tudominio.xxx"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt install nginx\n")),(0,r.kt)("p",null,"Creamos el fichero de configuraci\xf3n:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo nano /etc/nginx/sites-available/bookmedik.conf\n")),(0,r.kt)("p",null,"Y hacemos el proxy inverso:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen 80;\n    listen [::]:80;\n    server_name bookmedik.ottershell.es;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl;\n    listen [::]:443 ssl;\n    server_name bookmedik.ottershell.es;\n\n    ssl on;\n    ssl_certificate    /etc/letsencrypt/live/ottershell.es/fullchain.pem;\n    ssl_certificate_key    /etc/letsencrypt/live/ottershell.es/privkey.pem;\n\n    location / {\n        proxy_pass http://localhost:8081;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n}\n")),(0,r.kt)("p",null,"Activamos el sitio:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo ln -s /etc/nginx/sites-available/bookmedik.conf /etc/nginx/sites-enabled/\n")),(0,r.kt)("p",null,"Y reiniciamos nginx:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo systemctl restart nginx\n")),(0,r.kt)("p",null,"Por \xfaltimo, a\xf1adimos el dominio a nuestro VPS creando una entrada A en el panel de control de nuestro proveedor de dominio."),(0,r.kt)("h3",{id:"entrega-4"},"Entrega"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Entrega una captura de pantalla de Docker Hub donde se vea tu imagen subida.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(55058).Z,width:"1101",height:"924"})),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Entrega la configuraci\xf3n de nginx.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen 80;\n    listen [::]:80;\n    server_name bookmedik.ottershell.es;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl;\n    listen [::]:443 ssl;\n    server_name bookmedik.ottershell.es;\n\n    ssl on;\n    ssl_certificate    /etc/letsencrypt/live/ottershell.es/fullchain.pem;\n    ssl_certificate_key    /etc/letsencrypt/live/ottershell.es/privkey.pem;\n\n    location / {\n        proxy_pass http://localhost:8081;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n}\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Entrega una captura de pantalla donde se vea funcionando la aplicaci\xf3n, una vez que te has logueado.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(46813).Z,width:"1101",height:"924"})),(0,r.kt)("h2",{id:"tarea-6-modificaci\xf3n-de-la-aplicaci\xf3n"},"Tarea 6: Modificaci\xf3n de la aplicaci\xf3n"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"En el entorno de desarrollo vamos a hacer una modificaci\xf3n de la aplicaci\xf3n. Por ejemplo modifica el fichero ",(0,r.kt)("inlineCode",{parentName:"li"},"core/app/view/login-view.php")," y pon tu nombre en la l\xednea ",(0,r.kt)("inlineCode",{parentName:"li"},'<h4 class="title">Acceder a BookMedik</h4>'),"."),(0,r.kt)("li",{parentName:"ul"},"Vamos a trabajar con la primera imagen que construimos. Vuelve a crear la imagen con la etiqueta ",(0,r.kt)("inlineCode",{parentName:"li"},"v1_2"),"."),(0,r.kt)("li",{parentName:"ul"},"Cambia el ",(0,r.kt)("inlineCode",{parentName:"li"},"docker-compose")," para probar el cambio."),(0,r.kt)("li",{parentName:"ul"},"Modifica la aplicaci\xf3n en producci\xf3n.")),(0,r.kt)("p",null,"Modificamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"core/app/view/login-view.php")," y ponemos nuestro nombre en la l\xednea ",(0,r.kt)("inlineCode",{parentName:"p"},'<h4 class="title">Acceder a BookMedik</h4>'),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'nano core/app/view/login-view.php\n\n<h4 class="title">BELEN NAZARETH :)</h4>\n')),(0,r.kt)("p",null,"Creamos la imagen con la etiqueta ",(0,r.kt)("inlineCode",{parentName:"p"},"v1_2"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t belennazareth/bookmedik:v1_2 .\n")),(0,r.kt)("p",null,"Subimos la imagen a Docker Hub:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker push belennazareth/bookmedik:v1_2\n")),(0,r.kt)("p",null,"Modificamos el ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"version: '3.3'\nservices:\n  bn-mariadb:\n    container_name: bn-mariadb\n    image: mariadb\n    restart: always\n    environment:\n      MARIADB_ROOT_PASSWORD: root\n      MARIADB_DATABASE: bookmedik\n      MARIADB_USER: admin\n      MARIADB_PASSWORD: admin\n    volumes:\n      - mariadb_data:/var/lib/mysql\n  bookmedik:\n    container_name: bn-bookmedik\n    image: belennazareth/bookmedik:v1_2\n    restart: always\n    environment:\n      bookmedik_user: admin\n      bookmedik_passwd: admin\n      host_database: bn-mariadb\n      db_name: bookmedik\n    ports:\n      - 8081:80\n    depends_on:\n      - bn-mariadb\nvolumes:\n    mariadb_data:\n")),(0,r.kt)("p",null,"Levantamos los contenedores:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d\n")),(0,r.kt)("h3",{id:"entrega-5"},"Entrega"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Entrega una captura de pantalla de Docker Hub donde se vea tu imagen subida.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(71398).Z,width:"1101",height:"930"})),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Entrega una captura de pantalla donde se vea funcionando la aplicaci\xf3n, una vez que te has logueado.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"DOCKER",src:n(16879).Z,width:"1101",height:"924"}),"\n",(0,r.kt)("img",{alt:"DOCKER",src:n(4814).Z,width:"1101",height:"924"})))}m.isMDXComponent=!0},46813:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-10-48d1d4072a5f95f950b7f3ad881e4d19.png"},16879:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-11-865a3b28e77aa08ae04a792e3ac46ac4.png"},4814:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-12-48d1d4072a5f95f950b7f3ad881e4d19.png"},71398:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-13-6574ef3e12c7a21f2079d9fc83b8c73c.png"},56563:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-2-22f5faab1a3aa898dfb4cff059eced46.png"},56964:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-3-7edae5c9e64575d2a53c71c89f208ffc.png"},60942:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-4-ea658ebf4da4b1cf7e2ab598b428753e.png"},93752:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-5-7cfcdd01266cfb618e7bb850054fce2c.png"},31810:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-6-5f7e12e118c99340b3c4c059ed2e7890.png"},50702:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-7-b33d21af8c592d8efac5fef79331cd14.png"},76457:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-8-bda6a59a930ce429b81af7425622c6a8.png"},55058:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-9-06815dbc4e8093afe023a6d900933758.png"},69578:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/dockerPHPIAW6-8b949ab3ee4017b9a4fe7f7ff97faee9.png"}}]);