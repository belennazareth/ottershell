"use strict";(self.webpackChunkotter_shell=self.webpackChunkotter_shell||[]).push([[2319],{3905:(e,a,n)=>{n.d(a,{Zo:()=>p,kt:()=>m});var t=n(7294);function r(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function i(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function o(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach((function(a){r(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function l(e,a){if(null==e)return{};var n,t,r=function(e,a){if(null==e)return{};var n,t,r={},i=Object.keys(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||(r[n]=e[n]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=t.createContext({}),c=function(e){var a=t.useContext(s),n=a;return e&&(n="function"==typeof e?e(a):o(o({},a),e)),n},p=function(e){var a=c(e.components);return t.createElement(s.Provider,{value:a},e.children)},d={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},u=t.forwardRef((function(e,a){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,k=u["".concat(s,".").concat(m)]||u[m]||d[m]||i;return n?t.createElement(k,o(o({ref:a},p),{},{components:n})):t.createElement(k,o({ref:a},p))}));function m(e,a){var n=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var l={};for(var s in a)hasOwnProperty.call(a,s)&&(l[s]=a[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2981:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var t=n(7462),r=(n(7294),n(3905));const i={sidebar_position:29},o="Instalaci\xf3n y configuraci\xf3n del servidor DHCP",l={unversionedId:"Tasks/configuracion_dhcp",id:"Tasks/configuracion_dhcp",title:"Instalaci\xf3n y configuraci\xf3n del servidor DHCP",description:"1.- Crea una infraestructura en QEMU/KVM que te permita tener una m\xe1quina donde instalar un servidor dhcp y un cliente que se configuren para tomar la configuraci\xf3n de forma din\xe1mica. El servidor estar\xe1 conectado al cliente por una red interna muy aislada.",source:"@site/docs/Tasks/configuracion_dhcp.md",sourceDirName:"Tasks",slug:"/Tasks/configuracion_dhcp",permalink:"/docs/Tasks/configuracion_dhcp",draft:!1,editUrl:"https://github.com/belennazareth/ottershell/blob/main/docs/Tasks/configuracion_dhcp.md",tags:[],version:"current",sidebarPosition:29,frontMatter:{sidebar_position:29},sidebar:"tutorialSidebar",previous:{title:"Delegaci\xf3n de subdominios con bind9",permalink:"/docs/Tasks/bind9_subdominios"},next:{title:"Funcionamiento del servidor DHCP",permalink:"/docs/Tasks/funcionamiento_dhcp"}},s={},c=[{value:"Entrega",id:"entrega",level:2}],p={toc:c};function d(e){let{components:a,...i}=e;return(0,r.kt)("wrapper",(0,t.Z)({},p,i,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"instalaci\xf3n-y-configuraci\xf3n-del-servidor-dhcp"},"Instalaci\xf3n y configuraci\xf3n del servidor DHCP"),(0,r.kt)("p",null,"1.- Crea una infraestructura en QEMU/KVM que te permita tener una m\xe1quina donde instalar un servidor dhcp y un cliente que se configuren para tomar la configuraci\xf3n de forma din\xe1mica. El servidor estar\xe1 conectado al cliente por una red interna muy aislada."),(0,r.kt)("p",null,"Partimos de la creaci\xf3n de una red muy aislada, para esto se ha creado un fichero llamado ",(0,r.kt)("inlineCode",{parentName:"p"},"red-muy-aislada.xml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<network>\n  <name>red_muy_aislada</name>\n  <bridge name='virbr20'/>\n</network>\n")),(0,r.kt)("p",null,"Se crea con el comando:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"virsh -c qemu:///system net-define --file red-muy-aislada.xml\n")),(0,r.kt)("p",null,"Y se activa con el comando:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"virsh -c qemu:///system net-start red_muy_aislada \n")),(0,r.kt)("p",null,"Primero creamos las m\xe1quinas y copiamos la clave p\xfablica para acceder directamente a las m\xe1quinas ",(0,r.kt)("em",{parentName:"p"},"(ssh-copy-id dhcpclient/dhcpserver)"),"."),(0,r.kt)("p",null,"2.- Para instalar nuestro servidor dhcp ejecutamos:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo -y apt-get install isc-dhcp-server\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Nota: Cuando instalamos el servidor por primera se produce un error, ya que no est\xe1 configurado. Puedes ver los errores producidos por el servidor en el fichero ",(0,r.kt)("inlineCode",{parentName:"strong"},"/var/log/syslog")," o ",(0,r.kt)("inlineCode",{parentName:"strong"},"systemctl -u isc-dhcp-server"),".")),(0,r.kt)("p",null,"3.- Vamos a configurar la interfaz por la que va a trabajar el servidor dhcp, para ello editamos el siguiente fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/default/isc-dhcp-server"),". Donde configuramos el par\xe1metro interfaces (modif\xedcalo seg\xfan tu escenario), por ejemplo:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'INTERFACES="eth1"\n')),(0,r.kt)("p",null,"En mi caso, la interfaz que voy a utilizar es ",(0,r.kt)("inlineCode",{parentName:"p"},"enp1s0"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'INTERFACESv4="enp1s0"    \n')),(0,r.kt)("p",null,"Editamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/network/interfaces")," en el servidor y a\xf1adimos la siguiente l\xednea:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"allow-hotplug enp1s0\niface enp1s0 inet static\n        address 10.0.0.1    <<<\ud83c\udf38\ud83e\udd8e IP del servidor DHCP \ud83c\udf38\ud83e\udd8e\n        netmask 255.255.255.0\n")),(0,r.kt)("p",null,"Reiniciamos la m\xe1quina para que se apliquen los cambios."),(0,r.kt)("p",null,"Se usa una IP est\xe1tica para que el cliente pueda acceder al servidor dhcp, ya que de otra manera se conectar\xeda al dhcp de la red externa."),(0,r.kt)("p",null,"4.- Vamos a estudiar el fichero de configuraci\xf3n del servicio ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/dhcp/dhcpd.conf"),". "),(0,r.kt)("p",null,"El fichero de configuraci\xf3n est\xe1 dividido en dos partes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Parte principal (valores por defecto):")," especifica los par\xe1metros generales que definen la concesi\xf3n y los par\xe1metros adicionales que se proporcionar\xe1n al cliente.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Secciones (concretan a la principal):")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Subnet:")," Especifican rangos de direcciones IPs que ser\xe1n cedidas a los clientes que lo soliciten."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Host:")," Especificaciones concretas de equipos.")))),(0,r.kt)("p",null,"En la parte principal podemos configurar los siguientes par\xe1metros, que m\xe1s tarde podremos reescribir en las distintas secciones:"),(0,r.kt)("p",null,"Par\xe1metros de tiempos:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"max-lease-time:")," Es el tiempo m\xe1ximo en segundos de concesi\xf3n que un cliente puede solicitar. Si por ejemplo, un cliente solicita una concesi\xf3n de 900 segundos pero el tiempo m\xe1ximo es de 600 segundos, la concesi\xf3n tendr\xe1 una duraci\xf3n de 600 segundos. No tiene por qu\xe9 ser T3 o temporizador de alquiler.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"min-lease-time:")," Es el tiempo m\xednimo en segundos de concesi\xf3n que un cliente puede solicitar. Si por ejemplo, un cliente solicita una concesi\xf3n de 900 segundos pero el tiempo m\xednimo es de 1200 segundos, la concesi\xf3n tendr\xe1 una duraci\xf3n de 1200 segundos.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"default-lease-time:")," Es el tiempo por defecto en segundos de concesi\xf3n que se le asignar\xe1 a un cliente en caso de que \xe9ste no haya solicitado ning\xfan periodo en concreto. Estos tres primeros par\xe1metro determinan el tiempo T3 o tiempo de concesi\xf3n.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"option dhcp-renewal-time:")," Es el tiempo en segundos que ha de transcurrir hasta que el cliente pase al estado RENEWING. Tambi\xe9n conocido como T1 o temporizador de renovaci\xf3n de alquiler. No confundir con default-lease-time.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"option dhcp-rebinding-time:")," Es el tiempo en segundos que ha de transcurrir hasta que el cliente pase al estado REBINDING. Tambi\xe9n conocido como T2 o temporizador de reenganche."))),(0,r.kt)("p",null,"Par\xe1metros de configuraci\xf3n:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"option routers:")," Indicamos la direcci\xf3n red de la puerta de enlace que se utiliza para salir a internet.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"option domain-name-servers:")," Se pone las direcciones IP de los servidores DNS que va a utilizar el cliente.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"option domain-name:")," Nombre del dominio que se manda al cliente.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"option subnet-mask:")," Subred enviada a los clientes.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"option broadcast-address:")," Direcci\xf3n de difusi\xf3n de la red."))),(0,r.kt)("p",null,"Al indicar una secci\xf3n subnet tenemos que indicar la direcci\xf3n de la red y la mascara de red y entre llaves podemos poner los siguientes par\xe1metros:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"range:")," Indicamos el rango de direcciones IP que vamos a asignar.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Algunos de los par\xe1metros que hemos explicado en la secci\xf3n principal."))),(0,r.kt)("p",null,"5.- Configura el servidor DHCP con las siguientes caracter\xedsticas"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Rango de direcciones a repartir: 192.168.0.100 - 192.168.0.110"),(0,r.kt)("li",{parentName:"ul"},"M\xe1scara de red: 255.255.255.0"),(0,r.kt)("li",{parentName:"ul"},"Duraci\xf3n de la concesi\xf3n: 1 hora"),(0,r.kt)("li",{parentName:"ul"},"Puerta de enlace: 192.168.0.1"),(0,r.kt)("li",{parentName:"ul"},"Servidores DNS: 192.168.202.2 y 1.1.1.1")),(0,r.kt)("p",null,"La configuraci\xf3n usando los datos de mis m\xe1quinas quedar\xeda:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"subnet 10.0.0.0 netmask 255.255.255.0 {\n   default-lease-time 3600;\n   max-lease-time 3600;\n   range 10.0.0.100 10.0.0.110;\n   option subnet-mask 255.255.255.0;\n   option broadcast-address 10.0.0.255;\n   option routers 10.0.0.1;\n   option domain-name-servers 192.168.202.2, 1.1.1.1;\n}\n")),(0,r.kt)("p",null,"Reiniciamos el servicio para que se apliquen los cambios."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo systemctl restart isc-dhcp-server\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Nota 1: Si ponemos alg\xfan par\xe1metro fuera de la secci\xf3n subnet afectar\xe1 a todas las secciones subnet. Si dentro de la secci\xf3n subnet se reescribe el par\xe1metro no se utilizar\xe1 el valor del par\xe1metro general."),"\n",(0,r.kt)("strong",{parentName:"p"},"Nota 2: El tiempo T3 ser\xe1 default-lease-time si el cliente no ha solicitado tiempo de concesi\xf3n. Si el cliente lo ha solicitado no ser\xe1 mayor que max-lease-time ni menor que min-lease-time."),"\n",(0,r.kt)("strong",{parentName:"p"},"Nota 3: No hemos indicado ni el T1, ni el T2, por lo que estos valores se calcular\xe1n a partir de T3.")),(0,r.kt)("p",null,"6.- Configura los clientes para obtener direccionamiento din\xe1mico. Comprueba las configuraciones de red que han tomado los clientes."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Nota: En Windows la instrucci\xf3n ipconfig /release libera la concesi\xf3n, la instrucci\xf3n ipconfig /renew la renueva. En linux el comando para liberar la concesi\xf3n es dhclient -r y el que nos permite renovarla ser\xe1 dhclient.")),(0,r.kt)("p",null,"Configuramos el cliente para que tome la configuraci\xf3n de forma din\xe1mica, para ello editamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/network/interfaces")," y a\xf1adimos la siguiente l\xednea:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"allow-hotplug enp1s0\niface enp1s0 inet dhcp\n")),(0,r.kt)("p",null,"Reiniciamos la m\xe1quina."),(0,r.kt)("p",null,"7.- El servidor debe hacer router-nat para que el cliente tenga acceso a internet. La configuraci\xf3n debe ser persistente."),(0,r.kt)("p",null,"Para esto tenemos que activar el bit de forwarding editando el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/sysctl.conf")," y a\xf1adir la siguiente l\xednea:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"net.ipv4.ip_forward=1\n")),(0,r.kt)("p",null,"Instalamos iptables:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo apt-get install iptables\n")),(0,r.kt)("p",null,"Para que se haga permanente la configuraci\xf3n NAT, en el servidor, editamos el fichero ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/network/interfaces")," y a\xf1adimos la siguiente l\xednea:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"auto enp1s0\niface enp1s0 inet static\n        address 10.0.0.1\n        netmask 255.255.255.0\n        post-up iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o enp2s0 -j MASQUERADE    <<< \ud83c\udf3c\ud83d\udc38 configura el NAT \ud83d\udc38\ud83c\udf3c\n")),(0,r.kt)("p",null,"Para que se apliquen los cambios de ese fichero, reiniciamos el servicio de red con el comando:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo systemctl restart isc-dhcp-server\n")),(0,r.kt)("p",null,"O reiniciamos el servidor."),(0,r.kt)("p",null,"Para comprobar que esta funcionando iptables ejecutamos el comando:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo iptables -t nat -L -n\n")),(0,r.kt)("p",null,"En mi caso, aparece:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"debian@serverdhcp:~$ sudo iptables -t nat -L\n\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination         \n\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination         \n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination         \n\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination         \nMASQUERADE  all  --  10.0.0.0/24          anywhere      <<< \ud83c\udf08\ud83d\udc1d configuraci\xf3n activa de NAT \ud83d\udc1d\ud83c\udf08\n")),(0,r.kt)("p",null,"Para comprobar que funciona desde el cliente, podemos hacer ping a google:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"ping 8.8.8.8\n")),(0,r.kt)("p",null,"8.- Cuando el servidor va repartiendo la configuraci\xf3n a los clientes va guardando las concesiones en el fichero /var/lib/dhcp/dhcpd.leases."),(0,r.kt)("h2",{id:"entrega"},"Entrega"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"1.- Configuraci\xf3n del cliente para que configure la red de forma din\xe1mica.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cat /etc/network/interfaces\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"SRI",src:n(9382).Z,width:"703",height:"422"})),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"2.- Una vez que el cliente se haya configurado, capturas de pantalla donde se vea en el cliente: su direcci\xf3n IP, su puerta de enlace y su servidor DNS.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ip a\nip r\ncat /etc/resolv.conf\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"SRI",src:n(9919).Z,width:"938",height:"583"})),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"3.- La concesi\xf3n que se ha hecho en el servidor. Estar\xe1 en el fichero donde se guarda la lista de concesiones.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cat /var/lib/dhcp/dhcpd.leases\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"SRI",src:n(7027).Z,width:"759",height:"972"})),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"4.- Una comprobaci\xf3n del que el cliente puede hacer resoluci\xf3n a un nombre de internet.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ping 8.8.8.8\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"SRI",src:n(5237).Z,width:"644",height:"269"})))}d.isMDXComponent=!0},9919:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/taller1SRI2-2-b41a9aedc819b2bd8863df5b5e8892c0.png"},7027:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/taller1SRI2-3-139bb4071e9dfb2816ab3da823ec1e34.png"},5237:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/taller1SRI2-4-8d8ea1b46acf7d78eb22819767483640.png"},9382:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/taller1SRI2-d552236ab5b30ad57486ce877a5ad6d2.png"}}]);