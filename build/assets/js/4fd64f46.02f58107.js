"use strict";(self.webpackChunkotter_shell=self.webpackChunkotter_shell||[]).push([[8348],{3905:(e,n,a)=>{a.d(n,{Zo:()=>p,kt:()=>g});var r=a(67294);function o(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function t(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,r)}return a}function s(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?t(Object(a),!0).forEach((function(n){o(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function l(e,n){if(null==e)return{};var a,r,o=function(e,n){if(null==e)return{};var a,r,o={},t=Object.keys(e);for(r=0;r<t.length;r++)a=t[r],n.indexOf(a)>=0||(o[a]=e[a]);return o}(e,n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(r=0;r<t.length;r++)a=t[r],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var i=r.createContext({}),c=function(e){var n=r.useContext(i),a=n;return e&&(a="function"==typeof e?e(n):s(s({},n),e)),a},p=function(e){var n=c(e.components);return r.createElement(i.Provider,{value:n},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var a=e.components,o=e.mdxType,t=e.originalType,i=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(a),u=o,g=d["".concat(i,".").concat(u)]||d[u]||m[u]||t;return a?r.createElement(g,s(s({ref:n},p),{},{components:a})):r.createElement(g,s({ref:n},p))}));function g(e,n){var a=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var t=a.length,s=new Array(t);s[0]=u;var l={};for(var i in n)hasOwnProperty.call(n,i)&&(l[i]=n[i]);l.originalType=e,l[d]="string"==typeof e?e:o,s[1]=l;for(var c=2;c<t;c++)s[c]=a[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,a)}u.displayName="MDXCreateElement"},6416:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>m,frontMatter:()=>t,metadata:()=>l,toc:()=>c});var r=a(87462),o=(a(67294),a(3905));const t={sidebar_position:50},s="Docker: Implantaci\xf3n de aplicaciones web Python en docker",l={unversionedId:"Tasks/docker_PYTHON",id:"Tasks/docker_PYTHON",title:"Docker: Implantaci\xf3n de aplicaciones web Python en docker",description:"Despliegue en docker Django",source:"@site/docs/Tasks/docker_PYTHON.md",sourceDirName:"Tasks",slug:"/Tasks/docker_PYTHON",permalink:"/docs/Tasks/docker_PYTHON",draft:!1,editUrl:"https://github.com/belennazareth/ottershell/blob/main/docs/Tasks/docker_PYTHON.md",tags:[],version:"current",sidebarPosition:50,frontMatter:{sidebar_position:50},sidebar:"tutorialSidebar",previous:{title:"Docker: Implantaci\xf3n de aplicaciones web PHP en docker",permalink:"/docs/Tasks/docker_PHP"},next:{title:"Markdown Features",permalink:"/docs/Tasks/markdown-features"}},i={},c=[{value:"Despliegue en docker Django",id:"despliegue-en-docker-django",level:2},{value:"Entrega",id:"entrega",level:2},{value:"1. Crea una imagen docker para poder desplegar un contenedor con la aplicaci\xf3n. La imagen la puedes hacer desde una imagen base o desde la imagen oficial de python.",id:"1-crea-una-imagen-docker-para-poder-desplegar-un-contenedor-con-la-aplicaci\xf3n-la-imagen-la-puedes-hacer-desde-una-imagen-base-o-desde-la-imagen-oficial-de-python",level:3},{value:"2. Crea un docker-compose para desplegar los contenedores necesarios. Configura los vol\xfamenes que creas necesarios para que la aplicaci\xf3n sea persistente.",id:"2-crea-un-docker-compose-para-desplegar-los-contenedores-necesarios-configura-los-vol\xfamenes-que-creas-necesarios-para-que-la-aplicaci\xf3n-sea-persistente",level:3},{value:"3. Una vez probada en el entorno de desarrollo, despliega la aplicaci\xf3n en tu VPS usando el docker-compose y configurando el nginx como proxy inveso para acceder por nombre a la aplicaci\xf3n.",id:"3-una-vez-probada-en-el-entorno-de-desarrollo-despliega-la-aplicaci\xf3n-en-tu-vps-usando-el-docker-compose-y-configurando-el-nginx-como-proxy-inveso-para-acceder-por-nombre-a-la-aplicaci\xf3n",level:3}],p={toc:c},d="wrapper";function m(e){let{components:n,...t}=e;return(0,o.kt)(d,(0,r.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"docker-implantaci\xf3n-de-aplicaciones-web-python-en-docker"},"Docker: Implantaci\xf3n de aplicaciones web Python en docker"),(0,o.kt)("h2",{id:"despliegue-en-docker-django"},"Despliegue en docker Django"),(0,o.kt)("p",null,"Queremos desplegar en docker la aplicaci\xf3n escrita en python django: tutorial de django, que desplegamos en la tarea Despliegue de aplicaciones python."),(0,o.kt)("p",null,"Tienes que tener en cuenta los siguientes aspectos:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"La aplicaci\xf3n debe guardar los datos en una base de datos mariadb.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"La aplicaci\xf3n se podr\xe1 configurar para indicar los par\xe1metros de conexi\xf3n a la base de datos: usuario, contrase\xf1a, host y base de datos.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"La aplicaci\xf3n deber\xe1 tener creado un usuario administrador para el acceso."))),(0,o.kt)("p",null,"Primero vamos a clonar el repositorio de la aplicaci\xf3n:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/josedom24/django_tutorial.git\n")),(0,o.kt)("p",null,"En el entorno de desarrollo, creamos la red para los contenedores:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker network create django_net\n")),(0,o.kt)("p",null,"Creamos el contenedor de la base de datos:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d --name mariadb -v vol_polls:/var/lib/mysql --network django_net -e MARIADB_ROOT_PASSWORD=admin -e MARIADB_USER=django -e MARIADB_PASSWORD=admin -e MARIADB_DATABASE=django mariadb\n")),(0,o.kt)("p",null,"Modificamos el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"settings.py")," de la aplicaci\xf3n para que se conecte a la base de datos:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"# import os\n\nimport os\n\nBASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\n\n# base de datos\n\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.mysql',\n        'NAME': os.environ.get(\"BASE_DATOS\"),\n        'USER': os.environ.get('USUARIO'),\n        'PASSWORD': os.environ.get(\"CONTRA\"),\n        'HOST': os.environ.get('HOST'),\n        'PORT': '3306',\n    }\n}\n\n# host permitidos\n\nALLOWED_HOSTS = [os.environ.get(\"ALLOWED_HOSTS\")]\n\n# urls\n\nSTATIC_ROOT = os.path.join(BASE_DIR, 'static')\nSTATIC_URL = '/static/'\nCSRF_TRUSTED_ORIGINS = ['http://*.ottershell.es','http://*.127.0.0.1','https://*.ottershell.es','https://*.127.0.0.1']\n")),(0,o.kt)("p",null,"Creamos el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"polls.sh"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"#! /bin/sh\n\nsleep 2\npython3 manage.py makemigrations\npython3 manage.py migrate\npython3 manage.py createsuperuser --noinput\npython3 manage.py collectstatic --noinput\npython3 manage.py runserver 0.0.0.0:8006\n")),(0,o.kt)("p",null,"Creamos el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"Dockerfile"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM python:3\nWORKDIR /usr/src/app\nMAINTAINER Belen Nazareth Duran "belennazareth29@gmail.com"\nRUN pip install --root-user-action=ignore --upgrade pip && pip install --root-user-action=ignore django mysqlclient \nCOPY django/* /usr/src/app \nRUN mkdir static\nADD polls.sh /usr/src/app/\nRUN chmod +x /usr/src/app/polls.sh\nENTRYPOINT ["/usr/src/app/polls.sh"]\n')),(0,o.kt)("p",null,"Creamos la imagen:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t belennazareth/django:v1 .\n")),(0,o.kt)("p",null,"Creamos el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"version: '3.3'\nservices:\n  django-tutorial:\n    container_name: django-tutorial\n    image: belennazareth/django:v1\n    restart: always\n    environment:\n      ALLOWED_HOSTS: \"*\"\n      HOST: bd_mariadb_django\n      USUARIO: django\n      CONTRA: django\n      BASE_DATOS: django\n      DJANGO_SUPERUSER_PASSWORD: admin\n      DJANGO_SUPERUSER_USERNAME: admin\n      DJANGO_SUPERUSER_EMAIL: admin@admin.org\n    ports:\n      - 8084:8006\n    depends_on:\n      - db_django\n  db_django:\n    container_name: bd_mariadb_django\n    image: mariadb:10.5\n    restart: always\n    environment:\n      MARIADB_ROOT_PASSWORD: root\n      MARIADB_DATABASE: django\n      MARIADB_USER: django\n      MARIADB_PASSWORD: django\n    volumes:\n      - mariadb_data_django:/var/lib/mysql\nvolumes:\n    mariadb_data_django:\n")),(0,o.kt)("p",null,"Levantamos los contenedores:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"DOCKER",src:a(49134).Z,width:"1012",height:"1039"}),"\n",(0,o.kt)("img",{alt:"DOCKER",src:a(21697).Z,width:"1012",height:"1039"})),(0,o.kt)("p",null,"Ahora que ya hemos comprobado que funciona, vamos a subir la imagen a docker hub:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker push belennazareth/django:v1\n")),(0,o.kt)("p",null,"Para pasarlo al entorno de producci\xf3n, hay que a\xf1adir un registro de tipo A en el DNS que apunte a la IP del servidor. Adem\xe1s, con certbot, generamos un certificado para el dominio:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo certbot certonly --standalone -d django.ottershell.es\n")),(0,o.kt)("p",null,"Una vez hecho esto, en el entorno de producci\xf3n (VPS), creamos el proxy inverso con nginx:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nginx/sites-available/django.ottershell.es.conf\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n        listen 80;\n        listen [::]:80;\n\n        server_name django.ottershell.es;\n\n        return 301 https://$host$request_uri;\n}\n\nserver {\n        listen 443 ssl http2;\n        listen [::]:443 ssl http2;\n\n        ssl    on;\n        ssl_certificate    /etc/letsencrypt/live/django.ottershell.es/fullchain.pem;\n        ssl_certificate_key    /etc/letsencrypt/live/django.ottershell.es/privkey.pem;\n\n        index index.html index.php index.htm index.nginx-debian.html;\n\n        server_name django.ottershell.es;\n\n        location / {\n                proxy_pass http://localhost:8084;\n                include proxy_params;\n        }\n}\n")),(0,o.kt)("p",null,"Generamos el enlace simb\xf3lico:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ln -s /etc/nginx/sites-available/django.ottershell.es.conf /etc/nginx/sites-enabled/\n")),(0,o.kt)("p",null,"Reiniciamos nginx:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart nginx\n")),(0,o.kt)("p",null,"Hacemos un pull de la imagen de docker hub:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker pull belennazareth/django:v1\n")),(0,o.kt)("p",null,"Y copiamos el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," descrito anteriormente en el VPS. Lo levantamos:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up -d\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"DOCKER",src:a(92173).Z,width:"1014",height:"1039"}),"\n",(0,o.kt)("img",{alt:"DOCKER",src:a(90753).Z,width:"1402",height:"1039"}),"\n",(0,o.kt)("img",{alt:"DOCKER",src:a(86185).Z,width:"849",height:"572"}),"\n",(0,o.kt)("img",{alt:"DOCKER",src:a(23269).Z,width:"849",height:"572"})),(0,o.kt)("h2",{id:"entrega"},"Entrega"),(0,o.kt)("h3",{id:"1-crea-una-imagen-docker-para-poder-desplegar-un-contenedor-con-la-aplicaci\xf3n-la-imagen-la-puedes-hacer-desde-una-imagen-base-o-desde-la-imagen-oficial-de-python"},"1. Crea una imagen docker para poder desplegar un contenedor con la aplicaci\xf3n. La imagen la puedes hacer desde una imagen base o desde la imagen oficial de python."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM python:3\nWORKDIR /usr/src/app\nMAINTAINER Belen Nazareth Duran "belennazareth29@gmail.com"\nRUN pip install --root-user-action=ignore --upgrade pip && pip install --root-user-action=ignore django mysqlclient \nCOPY django/* /usr/src/app \nRUN mkdir static\nADD polls.sh /usr/src/app/\nRUN chmod +x /usr/src/app/polls.sh\nENTRYPOINT ["/usr/src/app/polls.sh"]\n')),(0,o.kt)("h3",{id:"2-crea-un-docker-compose-para-desplegar-los-contenedores-necesarios-configura-los-vol\xfamenes-que-creas-necesarios-para-que-la-aplicaci\xf3n-sea-persistente"},"2. Crea un docker-compose para desplegar los contenedores necesarios. Configura los vol\xfamenes que creas necesarios para que la aplicaci\xf3n sea persistente."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"version: '3.3'\nservices:\n  django-tutorial:\n    container_name: django-tutorial\n    image: belennazareth/django:v1\n    restart: always\n    environment:\n      ALLOWED_HOSTS: \"*\"\n      HOST: bd_mariadb_django\n      USUARIO: django\n      CONTRA: django\n      BASE_DATOS: django\n      DJANGO_SUPERUSER_PASSWORD: admin\n      DJANGO_SUPERUSER_USERNAME: admin\n      DJANGO_SUPERUSER_EMAIL: admin@admin.org\n    ports:\n      - 8084:8006\n    depends_on:\n      - db_django\n  db_django:\n    container_name: bd_mariadb_django\n    image: mariadb:10.5\n    restart: always\n    environment:\n      MARIADB_ROOT_PASSWORD: root\n      MARIADB_DATABASE: django\n      MARIADB_USER: django\n      MARIADB_PASSWORD: django\n    volumes:\n      - mariadb_data_django:/var/lib/mysql\nvolumes:\n    mariadb_data_django:\n")),(0,o.kt)("h3",{id:"3-una-vez-probada-en-el-entorno-de-desarrollo-despliega-la-aplicaci\xf3n-en-tu-vps-usando-el-docker-compose-y-configurando-el-nginx-como-proxy-inveso-para-acceder-por-nombre-a-la-aplicaci\xf3n"},"3. Una vez probada en el entorno de desarrollo, despliega la aplicaci\xf3n en tu VPS usando el docker-compose y configurando el nginx como proxy inveso para acceder por nombre a la aplicaci\xf3n."),(0,o.kt)("p",null,"Usamos el ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," descrito anteriormente. Adem\xe1s, creamos un proxy inverso con nginx:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n        listen 80;\n        listen [::]:80;\n\n        server_name django.ottershell.es;\n\n        return 301 https://$host$request_uri;\n}\n\nserver {\n        listen 443 ssl http2;\n        listen [::]:443 ssl http2;\n\n        ssl    on;\n        ssl_certificate    /etc/letsencrypt/live/django.ottershell.es/fullchain.pem;\n        ssl_certificate_key    /etc/letsencrypt/live/django.ottershell.es/privkey.pem;\n\n        index index.html index.php index.htm index.nginx-debian.html;\n\n        server_name django.ottershell.es;\n\n        location / {\n                proxy_pass http://localhost:8084;\n                include proxy_params;\n        }\n}\n")))}m.isMDXComponent=!0},21697:(e,n,a)=>{a.d(n,{Z:()=>r});const r=a.p+"assets/images/dockerPYTHONIAW6-2-e932a194979a12ff572f211e60f06bac.png"},92173:(e,n,a)=>{a.d(n,{Z:()=>r});const r=a.p+"assets/images/dockerPYTHONIAW6-3-37d627d25d1f62d21c301ba5a939ec2d.png"},90753:(e,n,a)=>{a.d(n,{Z:()=>r});const r=a.p+"assets/images/dockerPYTHONIAW6-4-597c869d0a85e4e96c782de189150b16.png"},86185:(e,n,a)=>{a.d(n,{Z:()=>r});const r=a.p+"assets/images/dockerPYTHONIAW6-5-7c7b49a1265bb793db215e3e1624f98d.png"},23269:(e,n,a)=>{a.d(n,{Z:()=>r});const r=a.p+"assets/images/dockerPYTHONIAW6-6-89955c3f7a4fbf4cfa5510c969fceefe.png"},49134:(e,n,a)=>{a.d(n,{Z:()=>r});const r=a.p+"assets/images/dockerPYTHONIAW6-e87d04c50a91b7f5255a563f1497a29b.png"}}]);