"use strict";(self.webpackChunkotter_shell=self.webpackChunkotter_shell||[]).push([[5165],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var a=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(t),m=o,f=u["".concat(l,".").concat(m)]||u[m]||d[m]||r;return t?a.createElement(f,i(i({ref:n},p),{},{components:t})):a.createElement(f,i({ref:n},p))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,i=new Array(r);i[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<r;c++)i[c]=t[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},6806:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var a=t(7462),o=(t(7294),t(3905));const r={sidebar_position:16},i="Configuraci\xf3n de HTTPS en el VPS",s={unversionedId:"Tasks/https",id:"Tasks/https",title:"Configuraci\xf3n de HTTPS en el VPS",description:"Vamos a configurar el protocolo HTTPS para el acceso a nuestras aplicaciones, para ello tienes que tener en cuenta los siguiente:",source:"@site/docs/Tasks/https.md",sourceDirName:"Tasks",slug:"/Tasks/https",permalink:"/docs/Tasks/https",draft:!1,editUrl:"https://github.com/belennazareth/ottershell/blob/main/docs/Tasks/https.md",tags:[],version:"current",sidebarPosition:16,frontMatter:{sidebar_position:16},sidebar:"tutorialSidebar",previous:{title:"Desplegando aplicaciones flask con apache2 + mod_wsgi",permalink:"/docs/Tasks/apache_wsgi"},next:{title:"Instalaci\xf3n/migraci\xf3n de aplicaciones web PHP",permalink:"/docs/Tasks/migracion_php"}},l={},c=[{value:"Procedimientos",id:"procedimientos",level:2},{value:"Entrega",id:"entrega",level:2},{value:"1. Captura de pantalla para comprobar que el navegador tiene el certificado de Let\u2019s Encrypt.",id:"1-captura-de-pantalla-para-comprobar-que-el-navegador-tiene-el-certificado-de-lets-encrypt",level:3},{value:"2. \xbfQu\xe9 opci\xf3n has elegido? \xbfQu\xe9 pruebas realiza Let\u2019s Encrypt para asegurar que somos los administradores del sitio web al elegir esa opci\xf3n?",id:"2-qu\xe9-opci\xf3n-has-elegido-qu\xe9-pruebas-realiza-lets-encrypt-para-asegurar-que-somos-los-administradores-del-sitio-web-al-elegir-esa-opci\xf3n",level:3},{value:"3. Entrega la configuraci\xf3n de nginx (los dos ficheros) para que funcione HTTPS y la redirecci\xf3n.",id:"3-entrega-la-configuraci\xf3n-de-nginx-los-dos-ficheros-para-que-funcione-https-y-la-redirecci\xf3n",level:3},{value:"4. Entrega la configuraci\xf3n del cron donde se ve que se har\xe1 la renovaci\xf3n cada 3 meses.",id:"4-entrega-la-configuraci\xf3n-del-cron-donde-se-ve-que-se-har\xe1-la-renovaci\xf3n-cada-3-meses",level:3},{value:"5. Captura de pantalla accediendo a las dos p\xe1ginas con https. Captura de pantalla con los detalles del certificado.",id:"5-captura-de-pantalla-accediendo-a-las-dos-p\xe1ginas-con-https-captura-de-pantalla-con-los-detalles-del-certificado",level:3},{value:"6. Captura de pantalla donde se vea el cliente de NextCloud conectado por https.",id:"6-captura-de-pantalla-donde-se-vea-el-cliente-de-nextcloud-conectado-por-https",level:3}],p={toc:c};function d(e){let{components:n,...r}=e;return(0,o.kt)("wrapper",(0,a.Z)({},p,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"configuraci\xf3n-de-https-en-el-vps"},"Configuraci\xf3n de HTTPS en el VPS"),(0,o.kt)("p",null,"Vamos a configurar el protocolo HTTPS para el acceso a nuestras aplicaciones, para ello tienes que tener en cuenta los siguiente:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Vamos a utilizar el servicio letsencrypt para solicitar los certificados de nuestras p\xe1ginas.")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Comprueba que el navegador tiene el certificado de Let\u2019s Encrypt.")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Solicita un certificado en Let\u2019s Encrypt. Tienes dos opciones:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Solicitar un certificado para el nombre que tienes: ",(0,o.kt)("a",{parentName:"p",href:"http://www.tudominio.algo"},"www.tudominio.algo"),".")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Solicitar un certificado wildcard *.tudominio.algo que te sirve para todos tus nombres. (Esta opci\xf3n te dar\xe1 m\xe1s puntos)."))),(0,o.kt)("ol",{start:4},(0,o.kt)("li",{parentName:"ol"},"Utiliza dos ficheros de configuraci\xf3n de nginx: uno para la configuraci\xf3n del virtualhost HTTP y otro para la configuraci\xf3n del virtualhost HTTPS.")),(0,o.kt)("ol",{start:5},(0,o.kt)("li",{parentName:"ol"},"Realiza una redirecci\xf3n o una reescritura para que cuando accedas a HTTP te redirija al sitio HTTPS.")),(0,o.kt)("ol",{start:6},(0,o.kt)("li",{parentName:"ol"},"Comprueba que se ha creado una tarea cron que renueva el certificado cada 3 meses.")),(0,o.kt)("ol",{start:7},(0,o.kt)("li",{parentName:"ol"},"Comprueba que las p\xe1ginas son accesible por HTTPS y visualiza los detalles del certificado que has creado.")),(0,o.kt)("ol",{start:8},(0,o.kt)("li",{parentName:"ol"},"Modifica la configuraci\xf3n del cliente de NextCloud para comprobar que sigue en funcionamiento con HTTPS.")),(0,o.kt)("h2",{id:"procedimientos"},"Procedimientos"),(0,o.kt)("p",null,"El primer paso para obtener el certificado ser\xe1 instalar ",(0,o.kt)("inlineCode",{parentName:"p"},"cerbot"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo apt install certbot\n")),(0,o.kt)("p",null,"Lo siguiente ser\xe1 dejar libre el puerto 80, para ello paramos el servidor nginx:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"systemctl stop nginx\n")),(0,o.kt)("p",null,"Para solicitar el ",(0,o.kt)("strong",{parentName:"p"},"wildcard")," hay que ejecutar:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo certbot certonly \\\n--manual \\\n--preferred-challenges=dns \\\n--email belennazareth29@gmail.com \\\n--server https://acme-v02.api.letsencrypt.org/directory \\\n--agree-tos \\\n-d *.ottershell.es\n")),(0,o.kt)("p",null,"Los par\xe1metros del comando son los siguientes:"),(0,o.kt)("p",null,"\ud83d\udc38 certonly: obtiene o renueva un certificado, pero no lo instala."),(0,o.kt)("p",null,"\ud83d\udc38 manual: obtiene el certificado de forma interactiva."),(0,o.kt)("p",null,"\ud83d\udc38 preferred-challenges=dns: es la forma en la que se le indica a Let\u2019s Encrypt que controlo en dominio (con DNS). Para ello pedir\xe1 que creemos un registro DNS de tipo TXT en nuestro dominio."),(0,o.kt)("p",null,"\ud83d\udc38 email: direcci\xf3n de correo electr\xf3nico para notificaciones importantes relacionadas con el certificado."),(0,o.kt)("p",null,"\ud83d\udc38 server: el servidor de Let\u2019s Encrypt contra el que se ejecutar\xe1n todas las operaciones."),(0,o.kt)("p",null,"\ud83d\udc38 agree-tos: acepto los t\xe9rminos de servicio de Let\u2019s Encrypt."),(0,o.kt)("p",null,"\ud83d\udc38 d: dominio para el que quiero obtener el certificado. Lleva un asterisco, lo que indica que va a ser wildcard."),(0,o.kt)("p",null,"Al ejecutarlo nos da diferentes opciones:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Primero pregunta si queremos compartir el correo con la EFF para que env\xeden informaci\xf3n sobre su trabajo:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nWould you be willing to share your email address with the Electronic Frontier\nFoundation, a founding partner of the Let's Encrypt project and the non-profit\norganization that develops Certbot? We'd like to send you email about our work\nencrypting the web, EFF news, campaigns, and ways to support digital freedom.\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n(Y)es/(N)o: y\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"La segunda ser\xe1 que la IP desde la que estoy ejecutando el comando ser\xe1 almacenada en registros p\xfabicos:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nNOTE: The IP of this machine will be publicly logged as having requested this\ncertificate. If you're running certbot in manual mode on a machine that is not\nyour server, please ensure you're okay with that.\n\nAre you OK with your IP being logged?\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n(Y)es/(N)o: y\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Lo siguiente que nos pide es que creemos una entrada en nuestro registro DNS de tipo TXT con los valores que nos da. El mensaje ser\xe1 parecido a:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nPlease deploy a DNS TXT record under the name\n_acme-challenge.dominio with the following value:\n\n{valor_ejemplo}\n\nBefore continuing, verify the record is deployed.\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nPress Enter to Continue\n\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Por \xfaltimo, al hacer ",(0,o.kt)("inlineCode",{parentName:"li"},"enter"),", comprobar\xe1 que todo est\xe9 correcto y si es as\xed nos dar\xe1 la ruta en la que se encuentra el certificado:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'Waiting for verification...\nCleaning up challenges\n\nIMPORTANT NOTES:\n - Congratulations! Your certificate and chain have been saved at:\n   /etc/letsencrypt/live/{dominio}/fullchain.pem\n   Your key file has been saved at:\n   /etc/letsencrypt/live/{dominio}/privkey.pem\n   Your cert will expire on 2023-03-03. To obtain a new or tweaked\n   version of this certificate in the future, simply run certbot\n   again. To non-interactively renew *all* of your certificates, run\n   "certbot renew"\n - Your account credentials have been saved in your Certbot\n   configuration directory at /etc/letsencrypt. You should make a\n   secure backup of this folder now. This configuration directory will\n   also contain certificates and private keys obtained by Certbot so\n   making regular backups of this folder is ideal.\n - If you like Certbot, please consider supporting our work by:\n\n   Donating to ISRG / Let\'s Encrypt:   https://letsencrypt.org/donate\n   Donating to EFF:                    https://eff.org/donate-le\n\n')),(0,o.kt)("p",null,"Comprobamos que se ha creado el cron, esto har\xe1 que el certificado se renueve autom\xe1ticamente cada 3 meses:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cat /etc/cron.d/certbot\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# /etc/cron.d/certbot: crontab entries for the certbot package\n#\n# Upstream recommends attempting renewal twice a day\n#\n# Eventually, this will be an opportunity to validate certificates\n# haven't been revoked, etc.  Renewal will only occur if expiration\n# is within 30 days.\n#\n# Important Note!  This cronjob will NOT be executed if you are\n# running systemd as your init system.  If you are running systemd,\n# the cronjob.timer function takes precedence over this cronjob.  For\n# more details, see the systemd.timer manpage, or use systemctl show\n# certbot.timer.\nSHELL=/bin/sh\nPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin\n\n0 */12 * * * root test -x /usr/bin/certbot -a \\! -d /run/systemd/system && perl -e 'sleep int(rand(43200))' && certbot -q renew\n")),(0,o.kt)("p",null,"En el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/nginx/sites-available")," creamos otro fichero, en este caso una copia del que ya ten\xedamos:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cp vps.conf vps-https.conf\n")),(0,o.kt)("p",null,"Modificamos el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"vps.conf"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen 80;\n    listen [::]:80;\n\n    server_name www.ottershell.es;\n    return 301 https://$host$request_uri;\n}\n")),(0,o.kt)("p",null,"Modificamos el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"vps-https.conf"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n\n    server_name www.ottershell.es;\n    root /var/www/html;\n\n    index index.php index.html index.htm index.nginx-debian.html;\n\n\n    ssl    on;\n    ssl_certificate    /etc/letsencrypt/live/ottershell.es/fullchain.pem;\n    ssl_certificate_key    /etc/letsencrypt/live/ottershell.es/privkey.pem;\n...\n")),(0,o.kt)("p",null,"Es necesario importar el certificado de Let's Encrypt si usamos google chrome."),(0,o.kt)("h2",{id:"entrega"},"Entrega"),(0,o.kt)("h3",{id:"1-captura-de-pantalla-para-comprobar-que-el-navegador-tiene-el-certificado-de-lets-encrypt"},"1. Captura de pantalla para comprobar que el navegador tiene el certificado de Let\u2019s Encrypt."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Term",src:t(2008).Z,width:"1277",height:"961"})),(0,o.kt)("h3",{id:"2-qu\xe9-opci\xf3n-has-elegido-qu\xe9-pruebas-realiza-lets-encrypt-para-asegurar-que-somos-los-administradores-del-sitio-web-al-elegir-esa-opci\xf3n"},"2. \xbfQu\xe9 opci\xf3n has elegido? \xbfQu\xe9 pruebas realiza Let\u2019s Encrypt para asegurar que somos los administradores del sitio web al elegir esa opci\xf3n?"),(0,o.kt)("p",null,"En mi caso he elegido la opci\xf3n con wildcard. He podido comprobar que Let\u2019s Encrypt, con este tipo de certificaci\xf3n, pide que creemos un registro DNS de tipo TXT en nuestro dominio con un valor proporcionado por el mismo programa."),(0,o.kt)("h3",{id:"3-entrega-la-configuraci\xf3n-de-nginx-los-dos-ficheros-para-que-funcione-https-y-la-redirecci\xf3n"},"3. Entrega la configuraci\xf3n de nginx (los dos ficheros) para que funcione HTTPS y la redirecci\xf3n."),(0,o.kt)("p",null,"Para la redirecci\xf3n se ha creado el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"vps.conf")," en ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/nginx/sites-available")," con contenido:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen 80;\n    listen [::]:80;\n\n    server_name www.ottershell.es;\n    return 301 https://$host$request_uri;\n}\n")),(0,o.kt)("p",null,"Y un fichero para https llamado ",(0,o.kt)("inlineCode",{parentName:"p"},"vps-https.conf")," ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/nginx/sites-available")," con contenido:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'server {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n\n    server_name www.ottershell.es;\n    root /var/www/html;\n\n    index index.php index.html index.htm index.nginx-debian.html;\n\n\n    ssl    on;\n    ssl_certificate    /etc/letsencrypt/live/ottershell.es/fullchain.pem;\n    ssl_certificate_key    /etc/letsencrypt/live/ottershell.es/privkey.pem;\n\n    location = /favicon.ico {\n        log_not_found off;\n        access_log off;\n    }\n\n    location = /robots.txt {\n        allow all;\n        log_not_found off;\n        access_log off;\n    }\n\n    location = / {\n        return 301 /portal;\n    }\n\n#    location /portal {\n#        try_files $uri $uri/ =404;\n#    }\n  \n    location ~ \\.php$ {\n        include snippets/fastcgi-php.conf;\n        fastcgi_pass unix:/run/php/php7.4-fpm.sock;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        include fastcgi_params;\n        fastcgi_intercept_errors on;\n        fastcgi_request_buffering off;\n    }\n\n    location ~ /\\.ht {\n         deny all;\n    }\n\n# nextcloud\n \n    location ^~ /cloud {\n        # set max upload size and increase upload timeout:\n        client_max_body_size 512M;\n        client_body_timeout 300s;\n        fastcgi_buffers 64 4K;\n        # Enable gzip but do not remove ETag headers\n        gzip on;\n        gzip_vary on;\n        gzip_comp_level 4;\n        gzip_min_length 256;\n        gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;\n        gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/wasm application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;\n        # HTTP response headers borrowed from cloud `.htaccess`\n        add_header Referrer-Policy                      "no-referrer"   always;\n        add_header X-Content-Type-Options               "nosniff"       always;\n        add_header X-Download-Options                   "noopen"        always;\n        add_header X-Frame-Options                      "SAMEORIGIN"    always;\n        add_header X-Permitted-Cross-Domain-Policies    "none"          always;\n        add_header X-Robots-Tag                         "none"          always;\n        add_header X-XSS-Protection                     "1; mode=block" always;\n\n        # Remove X-Powered-By, which is an information leak\n        fastcgi_hide_header X-Powered-By;\n        index index.php index.html /cloud/index.php$request_uri;\n\n        # Rule borrowed from `.htaccess` to handle Microsoft DAV clients\n        location = /cloud {\n            if ( $http_user_agent ~ ^DavClnt ) {\n                return 302 /cloud/remote.php/webdav/$is_args$args;\n            }\n        }\n\n        # Rules borrowed from `.htaccess` to hide certain paths from clients\n        location ~ ^/cloud/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/)    { return 404; }\n        location ~ ^/cloud/(?:\\.|autotest|occ|issue|indie|db_|console)                  { return 404; }\n        location ~ \\.php(?:$|/) {\n            # Required for legacy support\n            rewrite ^/cloud/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /cloud/index.php$request_uri;\n\n            fastcgi_split_path_info ^(.+?\\.php)(/.*)$;\n            set $path_info $fastcgi_path_info;\n\n            try_files $fastcgi_script_name =404;\n\n            include fastcgi_params;\n            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n            fastcgi_param PATH_INFO $path_info;\n           # fastcgi_param HTTPS on;\n\n            fastcgi_param modHeadersAvailable true;         # Avoid sending the security headers twice\n            fastcgi_param front_controller_active true;     # Enable pretty urls\n            fastcgi_pass unix:/run/php/php7.4-fpm.sock;\n\n            fastcgi_intercept_errors on;\n            fastcgi_request_buffering off;\n\n            fastcgi_max_temp_file_size 0;\n        }\n        location ~ \\.(?:css|js|svg|gif|png|jpg|ico|wasm|tflite|map)$ {\n            try_files $uri /cloud/index.php$request_uri;\n            add_header Cache-Control "public, max-age=15778463";\n            access_log off;     # Optional: Don\'t log access to assets\n\n            location ~ \\.wasm$ {\n                default_type application/wasm;\n            }\n        }\n        location ~ \\.woff2?$ {\n            try_files $uri /cloud/index.php$request_uri;\n            expires 7d;         # Cache-Control policy borrowed from `.htaccess`\n            access_log off;     # Optional: Don\'t log access to assets\n        }\n        # Rule borrowed from `.htaccess`\n        location /cloud/remote {\n            return 301 /cloud/remote.php$request_uri;\n        }\n        location /cloud {\n            try_files $uri $uri/ /cloud/index.php$request_uri;\n        }\n    }\n\n# portal\n\n    location ^~ /portal {\n        # set max upload size and increase upload timeout:\n        client_max_body_size 512M;\n        client_body_timeout 300s;\n        fastcgi_buffers 64 4K;\n        # Enable gzip but do not remove ETag headers\n        gzip on;\n        gzip_vary on;\n        gzip_comp_level 4;\n        gzip_min_length 256;\n        gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;\n        gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/wasm application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;\n        # HTTP response headers borrowed from portal `.htaccess`\n        add_header Referrer-Policy                      "no-referrer"   always;\n        add_header X-Content-Type-Options               "nosniff"       always;\n        add_header X-Download-Options                   "noopen"        always;\n        add_header X-Frame-Options                      "SAMEORIGIN"    always;\n        add_header X-Permitted-Cross-Domain-Policies    "none"          always;\n        add_header X-Robots-Tag                         "none"          always;\n        add_header X-XSS-Protection                     "1; mode=block" always;\n\n        # Remove X-Powered-By, which is an information leak\n        fastcgi_hide_header X-Powered-By;\n        index index.php index.html /portal/index.php$request_uri;\n\n        # Rule borrowed from `.htaccess` to handle Microsoft DAV clients\n        location = /portal {\n            if ( $http_user_agent ~ ^DavClnt ) {\n                return 302 /portal/remote.php/webdav/$is_args$args;\n            }\n        }\n\n        # Rules borrowed from `.htaccess` to hide certain paths from clients\n        location ~ ^/portal/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/)    { return 404; }\n        location ~ ^/portal/(?:\\.|autotest|occ|issue|indie|db_|console)                  { return 404; }\n        location ~ \\.php(?:$|/) {\n            # Required for legacy support\n            rewrite ^/portal/(?!index|remote|public|cron|core\\/ajax\\/update|status|ocs\\/v[12]|updater\\/.+|oc[ms]-provider\\/.+|.+\\/richdocumentscode\\/proxy) /portal/index.php$request_uri;\n\n            fastcgi_split_path_info ^(.+?\\.php)(/.*)$;\n            set $path_info $fastcgi_path_info;\n\n            try_files $fastcgi_script_name =404;\n\n            include fastcgi_params;\n            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n            fastcgi_param PATH_INFO $path_info;\n           # fastcgi_param HTTPS on;\n\n            fastcgi_param modHeadersAvailable true;         # Avoid sending the security headers twice\n            fastcgi_param front_controller_active true;     # Enable pretty urls\n            fastcgi_pass unix:/run/php/php7.4-fpm.sock;\n\n            fastcgi_intercept_errors on;\n            fastcgi_request_buffering off;\n\n            fastcgi_max_temp_file_size 0;\n        }\n        location ~ \\.(?:css|js|svg|gif|png|jpg|ico|wasm|tflite|map)$ {\n            try_files $uri /portal/index.php$request_uri;\n            add_header Cache-Control "public, max-age=15778463";\n            access_log off;     # Optional: Don\'t log access to assets\n\n            location ~ \\.wasm$ {\n                default_type application/wasm;\n            }\n        }\n        location ~ \\.woff2?$ {\n            try_files $uri /portal/index.php$request_uri;\n            expires 7d;         # Cache-Control policy borrowed from `.htaccess`\n            access_log off;     # Optional: Don\'t log access to assets\n        }\n        # Rule borrowed from `.htaccess`\n        location /portal/remote {\n            return 301 /portal/remote.php$request_uri;\n        }\n        location /portal {\n            try_files $uri $uri/ /portal/index.php$request_uri;\n        }\n    }\n    location /admin {\n       return 301 /portal$request_uri;\n    }\n}\n')),(0,o.kt)("h3",{id:"4-entrega-la-configuraci\xf3n-del-cron-donde-se-ve-que-se-har\xe1-la-renovaci\xf3n-cada-3-meses"},"4. Entrega la configuraci\xf3n del cron donde se ve que se har\xe1 la renovaci\xf3n cada 3 meses."),(0,o.kt)("p",null,"La configuraci\xf3n la crea ",(0,o.kt)("inlineCode",{parentName:"p"},"cerbot")," autom\xe1ticamente y se encuentra en el fichero ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/cron.d/certbot"),": "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# /etc/cron.d/certbot: crontab entries for the certbot package\n#\n# Upstream recommends attempting renewal twice a day\n#\n# Eventually, this will be an opportunity to validate certificates\n# haven't been revoked, etc.  Renewal will only occur if expiration\n# is within 30 days.\n#\n# Important Note!  This cronjob will NOT be executed if you are\n# running systemd as your init system.  If you are running systemd,\n# the cronjob.timer function takes precedence over this cronjob.  For\n# more details, see the systemd.timer manpage, or use systemctl show\n# certbot.timer.\nSHELL=/bin/sh\nPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin\n\n0 */12 * * * root test -x /usr/bin/certbot -a \\! -d /run/systemd/system && perl -e 'sleep int(rand(43200))' && certbot -q renew\n")),(0,o.kt)("h3",{id:"5-captura-de-pantalla-accediendo-a-las-dos-p\xe1ginas-con-https-captura-de-pantalla-con-los-detalles-del-certificado"},"5. Captura de pantalla accediendo a las dos p\xe1ginas con https. Captura de pantalla con los detalles del certificado."),(0,o.kt)("p",null,"Entrando en ",(0,o.kt)("inlineCode",{parentName:"p"},"www.ottershell.es"),":"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Term",src:t(9198).Z,width:"1277",height:"981"})),(0,o.kt)("p",null,"Entrando en ",(0,o.kt)("inlineCode",{parentName:"p"},"www.ottershell.es/cloud"),":"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Term",src:t(1037).Z,width:"1277",height:"981"})),(0,o.kt)("h3",{id:"6-captura-de-pantalla-donde-se-vea-el-cliente-de-nextcloud-conectado-por-https"},"6. Captura de pantalla donde se vea el cliente de NextCloud conectado por https."),(0,o.kt)("p",null,"Entrando en la aplicaci\xf3n, si entramos en ",(0,o.kt)("inlineCode",{parentName:"p"},"ajustes")," podemos comprobar que se ha realizado la redirecci\xf3n ",(0,o.kt)("strong",{parentName:"p"},"https"),":"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Term",src:t(6820).Z,width:"1166",height:"723"})))}d.isMDXComponent=!0},9198:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/httpsIAW3-2-2f016e0783ea9d1bd78747a167e72134.png"},1037:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/httpsIAW3-3-d59f6aa5976eafd243b511143ab44887.png"},6820:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/httpsIAW3-4-594f75f7c75db850871a89fe6a6b6a0d.png"},2008:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/httpsIAW3-55833aefd93fee26979230e27aa64cb0.png"}}]);