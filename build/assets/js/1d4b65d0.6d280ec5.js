"use strict";(self.webpackChunkotter_shell=self.webpackChunkotter_shell||[]).push([[260],{3905:(e,a,n)=>{n.d(a,{Zo:()=>d,kt:()=>k});var r=n(67294);function t(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function o(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);a&&(r=r.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?o(Object(n),!0).forEach((function(a){t(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function l(e,a){if(null==e)return{};var n,r,t=function(e,a){if(null==e)return{};var n,r,t={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],a.indexOf(n)>=0||(t[n]=e[n]);return t}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(t[n]=e[n])}return t}var s=r.createContext({}),c=function(e){var a=r.useContext(s),n=a;return e&&(n="function"==typeof e?e(a):i(i({},a),e)),n},d=function(e){var a=c(e.components);return r.createElement(s.Provider,{value:a},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var a=e.children;return r.createElement(r.Fragment,{},a)}},m=r.forwardRef((function(e,a){var n=e.components,t=e.mdxType,o=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=c(n),m=t,k=u["".concat(s,".").concat(m)]||u[m]||p[m]||o;return n?r.createElement(k,i(i({ref:a},d),{},{components:n})):r.createElement(k,i({ref:a},d))}));function k(e,a){var n=arguments,t=a&&a.mdxType;if("string"==typeof e||t){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in a)hasOwnProperty.call(a,s)&&(l[s]=a[s]);l.originalType=e,l[u]="string"==typeof e?e:t,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},54748:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var r=n(87462),t=(n(67294),n(3905));const o={sidebar_position:27},i="Protocolo DHCP",l={unversionedId:"Tasks/dhcp",id:"Tasks/dhcp",title:"Protocolo DHCP",description:"Procedimiento",source:"@site/docs/Tasks/dhcp.md",sourceDirName:"Tasks",slug:"/Tasks/dhcp",permalink:"/docs/Tasks/dhcp",draft:!1,editUrl:"https://github.com/belennazareth/ottershell/blob/main/docs/Tasks/dhcp.md",tags:[],version:"current",sidebarPosition:27,frontMatter:{sidebar_position:27},sidebar:"tutorialSidebar",previous:{title:"Instalaci\xf3n y configuraci\xf3n de un servidor DNS esclavo",permalink:"/docs/Tasks/DNS_esclavo"},next:{title:"Introducci\xf3n a iSCSI",permalink:"/docs/Tasks/iSCSI"}},s={},c=[{value:"Procedimiento",id:"procedimiento",level:2},{value:"Entrega",id:"entrega",level:2},{value:"1. Entrega la URL del repositorio GitHub donde has alojado todos los ficheros.",id:"1-entrega-la-url-del-repositorio-github-donde-has-alojado-todos-los-ficheros",level:3},{value:"2. Entrega el fichero de configuraci\xf3n del servidor DHCP despu\xe9s de ejecutar el playbook de ansible.",id:"2-entrega-el-fichero-de-configuraci\xf3n-del-servidor-dhcp-despu\xe9s-de-ejecutar-el-playbook-de-ansible",level:3},{value:"3. Entrega el fichero de configuraci\xf3n de red del cliente (para comprobar que toma direccionamiento din\xe1mico) y que ha tomado la direcci\xf3n reservada en el servidor DHCP.",id:"3-entrega-el-fichero-de-configuraci\xf3n-de-red-del-cliente-para-comprobar-que-toma-direccionamiento-din\xe1mico-y-que-ha-tomado-la-direcci\xf3n-reservada-en-el-servidor-dhcp",level:3},{value:"4. Entrega el fichero de configuraci\xf3n de red de la otra m\xe1quina cliente, la direcci\xf3n que ha tomado y el fichero de concesiones del servidor donde se demuestra que se ha repartido.",id:"4-entrega-el-fichero-de-configuraci\xf3n-de-red-de-la-otra-m\xe1quina-cliente-la-direcci\xf3n-que-ha-tomado-y-el-fichero-de-concesiones-del-servidor-donde-se-demuestra-que-se-ha-repartido",level:3},{value:"5. Comprueba que la nueva m\xe1quina cliente no tiene el servidor apache2 instalado, y una captura de pantalla comprobando que sigue siendo accesible el servidor web de cliente.",id:"5-comprueba-que-la-nueva-m\xe1quina-cliente-no-tiene-el-servidor-apache2-instalado-y-una-captura-de-pantalla-comprobando-que-sigue-siendo-accesible-el-servidor-web-de-cliente",level:3}],d={toc:c},u="wrapper";function p(e){let{components:a,...n}=e;return(0,t.kt)(u,(0,r.Z)({},d,n,{components:a,mdxType:"MDXLayout"}),(0,t.kt)("h1",{id:"protocolo-dhcp"},"Protocolo DHCP"),(0,t.kt)("h2",{id:"procedimiento"},"Procedimiento"),(0,t.kt)("p",null,"Vamos a continuar trabajando en el escenario que desarrollamos en la ",(0,t.kt)("a",{parentName:"p",href:"https://ottershell.vercel.app/docs/Tasks/router_nat"},"Pr\xe1ctica: Creaci\xf3n y configuraci\xf3n de un escenario router-nat"),"."),(0,t.kt)("p",null,"Para evitar los problemas que nos puede causar vagrant a la hora de trabajar con el DHCP (los clientes tendr\xedan dos servidores DHCP, el que estamos configurando y el de la red de mantenimiento por eth0), os sugiero:"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"Que mont\xe9is el mismo escenario pero en kvm/libvirt, en relaci\xf3n a las redes:")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"No tendr\xedamos la interfaz conectada a la red de mantenimiento de vagrant.")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Conectar\xedamos las m\xe1quinas a una red NAT sin dhcp (con IP est\xe1tica) que utilizar\xedamos para configurar las m\xe1quinas por ansible. Esto soluciona el problema de que las direcciones IP cambien en vagrant y tengamos que cambiar el inventario cada vez que creemos el escenario."))),(0,t.kt)("ol",{start:2},(0,t.kt)("li",{parentName:"ol"},"Ejecutamos el playbook de la pr\xe1ctica anterior y comprobamos que las m\xe1quinas tienen el funcionamiento esperado.")),(0,t.kt)("p",null,"A partir de esta configuraci\xf3n podr\xedamos seguir con esta pr\xe1ctica."),(0,t.kt)("p",null,"Para esta pr\xe1ctica vamos a utilizar una m\xe1quina router que tendr\xe1 dos interfaces de red, una por defecto para la conexi\xf3n al exterior y otra para la red interna que ser\xe1 la que haga DHCP a las m\xe1quinas clientes. Los clientes tendran una red interna que se conectar\xe1 a la red interna del router por DHCP."),(0,t.kt)("p",null,(0,t.kt)("strong",{parentName:"p"},'TODAS LAS M\xc1QUINAS TENDR\xc1N UNA RED AISLADA DE "MANTENIMIENTO" PARA PODER USAR ESAS IPs PARA EJECUTARLES EL PLAYBOOK DEL ANSIBLE')),(0,t.kt)("p",null,"Primero creamos una red aislada que usar\xe1n como red interna las m\xe1quinas clientes y el router:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"<network>\n  <name>interna</name>\n  <bridge name='virbr17'/>\n  <ip address='192.168.123.1' netmask='255.255.255.0'>\n    <dhcp>\n      <range start='192.168.123.2' end='192.168.123.254'/>\n    </dhcp>\n  </ip>\n</network>\n")),(0,t.kt)("p",null,"La definimos en libvirt:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"virsh -c qemu:///system net-define interna.xml\nvirsh -c qemu:///system net-start interna\nvirsh -c qemu:///system net-autostart interna\n")),(0,t.kt)("p",null,"Usaremos la red interna para conectar las m\xe1quinas clientes y el router.\nLa red externa/mantenimientoparaejecutarelplaybook no es necesario crearla ya que usaremos la red por defecto (",(0,t.kt)("inlineCode",{parentName:"p"},"default"),")."),(0,t.kt)("p",null,"Ahora creamos la m\xe1quina router:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"virt-install --connect qemu:///system --virt-type kvm --name router-dhcp --cdrom ~/Escritorio/ISOS/debian-11.5.0-amd64-netinst.iso --os-variant debian10 --disk size=15 --memory 2000 --vcpus 2 \n")),(0,t.kt)("p",null,"Creamos la m\xe1quina cliente:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"virt-install --connect qemu:///system --virt-type kvm --name cliente-dhcp --cdrom ~/Escritorio/ISOS/debian-11.5.0-amd64-netinst.iso --os-variant debian10 --disk size=15 --memory 2000 --vcpus 2 \n")),(0,t.kt)("p",null,"A\xf1adimos la red interna con virsh:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"virsh -c qemu:///system attach-interface --domain router-dhcp --type network --source interna --model virtio --persistent\nvirsh -c qemu:///system attach-interface --domain cliente-dhcp --type network --source interna --model virtio --persistent\n")),(0,t.kt)("p",null,"Editamos los ficheros de ambas m\xe1quinas para que tengan una IP est\xe1tica en la red de mantenimiento y una IP din\xe1mica en la red interna, la cual se a\xf1adir\xe1 si no existe en el fichero ",(0,t.kt)("inlineCode",{parentName:"p"},"/etc/network/interfaces"),":"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"--- /etc/network/interfaces ROUTER\n\n# This file describes the network interfaces available on your system\n# and how to activate them. For more information, see interfaces(5).\n\nsource /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\nallow-hotplug enp1s0\niface enp1s0 inet static\n        address 192.168.132.169\n        netmask 255.255.255.0\n        network 192.168.132.0\n        broadcast 192.168.132.255\n        gateway 192.168.132.1\n\nallow-hotplug enp7s0\niface enp7s0 inet dhcp\n\n*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*\n\n--- /etc/network/interfaces CLIENTE\n\n# This file describes the network interfaces available on your system\n# and how to activate them. For more information, see interfaces(5).\n\nsource /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\nallow-hotplug enp1s0\niface enp1s0 inet static\n        address 192.168.132.246\n        netmask 255.255.255.0\n        network 192.168.132.0\n        broadcast 192.168.132.255\n        gateway 192.168.132.1\n\nallow-hotplug enp1s0\niface enp7s0 inet dhcp\n")),(0,t.kt)("p",null,"Despu\xe9s de esto, levantamos las interfaces de las m\xe1quinas:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"ifup enp1s0\nifup enp7s0\n")),(0,t.kt)("table",null,(0,t.kt)("thead",{parentName:"table"},(0,t.kt)("tr",{parentName:"thead"},(0,t.kt)("th",{parentName:"tr",align:null},"maquina"),(0,t.kt)("th",{parentName:"tr",align:null},"ip"))),(0,t.kt)("tbody",{parentName:"table"},(0,t.kt)("tr",{parentName:"tbody"},(0,t.kt)("td",{parentName:"tr",align:null},"router-dhcp"),(0,t.kt)("td",{parentName:"tr",align:null},"192.168.132.169")),(0,t.kt)("tr",{parentName:"tbody"},(0,t.kt)("td",{parentName:"tr",align:null},"cliente-dhcp"),(0,t.kt)("td",{parentName:"tr",align:null},"192.168.132.246")))),(0,t.kt)("p",null,"Modificamos el ansible con las nuevas ip en el fichero ",(0,t.kt)("inlineCode",{parentName:"p"},"hosts"),":"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"all:\n  children:\n    router_client:\n      hosts:\n        router-dhcp: \n          ansible_ssh_host: 192.168.132.169\n          ansible_ssh_user: usuario\n          ansible_ssh_pass: usuario\n          ansible_become_pass: usuario\n          \n        cliente-dhcp:\n          ansible_ssh_host: 192.168.132.246\n          ansible_ssh_user: usuario\n          ansible_ssh_pass: usuario\n          ansible_become_pass: usuario\n")),(0,t.kt)("p",null,"Las variables que usaremos en el playbook son las siguientes:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-bash"},"r_privada: 192.168.123.0/24\nip_router: 192.168.123.204\nip_cliente: 192.168.123.160\n")),(0,t.kt)("p",null,"Con esto ya podemos ejecutar el playbook de la pr\xe1ctica anterior y comprobar que las m\xe1quinas tienen el funcionamiento esperado."),(0,t.kt)("p",null,"\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\ud83d\udc1a\u200a                 \ud83d\udc1a\u200a                    \ud83d\udc1a\u200a                     \ud83d\udc1a\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164\u3164"),(0,t.kt)("p",null,"Queremos instalar un servidor DHCP en la m\xe1quina router para que configure de forma autom\xe1tica las m\xe1quinas que se conectan en la red interna. Tenemos que tener en cuenta lo siguiente:"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"La m\xe1quina cliente de la pr\xe1ctica anterior, que tiene instalado el servidor web, debe tener la misma IP que la que le as\xedgnaste est\xe1ticamente, por lo tanto haremos una reserva para que tenga la misma IP.")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Al a\xf1adir una nueva m\xe1quina a la red local (recuerda que no se le instalar\xe1 el servidor web) se configurar\xe1 de forma din\xe1mica.")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Crea un nuevo rol en el playbook de ansible llamado dhcp que configure el servidor DHCP de forma correcta. Quiz\xe1s sea necesario modificar el comportamiento de alg\xfan rol de la pr\xe1ctica anterior.")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Todos los par\xe1metros que reparta el servidor DHCP, as\xed como cualquier otro dato, por ejemplo la direcci\xf3n MAC del cliente se guardar\xe1n en variables.")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"A\xf1ade una nueva m\xe1quina al escenario conectada a la red interna muy aislada. Vuelve a ejecutar el playbook y comprueba que todo funciona de forma correcta."))),(0,t.kt)("h2",{id:"entrega"},"Entrega"),(0,t.kt)("h3",{id:"1-entrega-la-url-del-repositorio-github-donde-has-alojado-todos-los-ficheros"},"1. Entrega la URL del repositorio GitHub donde has alojado todos los ficheros."),(0,t.kt)("h3",{id:"2-entrega-el-fichero-de-configuraci\xf3n-del-servidor-dhcp-despu\xe9s-de-ejecutar-el-playbook-de-ansible"},"2. Entrega el fichero de configuraci\xf3n del servidor DHCP despu\xe9s de ejecutar el playbook de ansible."),(0,t.kt)("h3",{id:"3-entrega-el-fichero-de-configuraci\xf3n-de-red-del-cliente-para-comprobar-que-toma-direccionamiento-din\xe1mico-y-que-ha-tomado-la-direcci\xf3n-reservada-en-el-servidor-dhcp"},"3. Entrega el fichero de configuraci\xf3n de red del cliente (para comprobar que toma direccionamiento din\xe1mico) y que ha tomado la direcci\xf3n reservada en el servidor DHCP."),(0,t.kt)("h3",{id:"4-entrega-el-fichero-de-configuraci\xf3n-de-red-de-la-otra-m\xe1quina-cliente-la-direcci\xf3n-que-ha-tomado-y-el-fichero-de-concesiones-del-servidor-donde-se-demuestra-que-se-ha-repartido"},"4. Entrega el fichero de configuraci\xf3n de red de la otra m\xe1quina cliente, la direcci\xf3n que ha tomado y el fichero de concesiones del servidor donde se demuestra que se ha repartido."),(0,t.kt)("h3",{id:"5-comprueba-que-la-nueva-m\xe1quina-cliente-no-tiene-el-servidor-apache2-instalado-y-una-captura-de-pantalla-comprobando-que-sigue-siendo-accesible-el-servidor-web-de-cliente"},"5. Comprueba que la nueva m\xe1quina cliente no tiene el servidor apache2 instalado, y una captura de pantalla comprobando que sigue siendo accesible el servidor web de cliente."),(0,t.kt)("p",null,"*Nota: Tuve problemas con la red default dandome un error al iniciarla donde dec\xeda que ya exist\xeda o estaba en uso, aunque segu\xeda estando inactiva realmente y no me dejaba la opci\xf3n de iniciarla. Para solucionarlo segu\xed estos pasoss:"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Quitar la definici\xf3n de la red default con virsh:"),(0,t.kt)("p",{parentName:"li"},"virsh -c qemu:///system net-undefine default")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Editar el fichero de la red default:"),(0,t.kt)("p",{parentName:"li"},"sudo nano /etc/libvirt/qemu/networks/default.xml")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"En mi caso, decidi cambiar el rango que ten\xeda por defecto:"),(0,t.kt)("network",null,(0,t.kt)("name",null,"default"),(0,t.kt)("bridge",{name:"virbr0"}),(0,t.kt)("forward",null),(0,t.kt)("ip",{address:"192.168.132.1",netmask:"255.255.255.0"},(0,t.kt)("dhcp",null,(0,t.kt)("range",{start:"192.168.132.2",end:"192.168.132.254"}))))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Eliminar el bridge que se hab\xeda creado:"),(0,t.kt)("p",{parentName:"li"},"sudo ip link set virbr0 down\nsudo brctl delbr virbr0")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Definir la red default con virsh:"),(0,t.kt)("p",{parentName:"li"},"virsh -c qemu:///system net-define /etc/libvirt/qemu/networks/default.xml")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Y la iniciamos:"),(0,t.kt)("p",{parentName:"li"},"virsh -c qemu:///system net-start default")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Tambi\xe9n ponemos que se autoinicie:"),(0,t.kt)("p",{parentName:"li"},"virsh -c qemu:///system net-autostart default")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Comprobamos que se ha creado correctamente:"),(0,t.kt)("p",{parentName:"li"},"virsh -c qemu:///system net-list --all")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Y que est\xe1 activa:"),(0,t.kt)("p",{parentName:"li"},"virsh -c qemu:///system net-dhcp-leases default"))))}p.isMDXComponent=!0}}]);